<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Documentación Backend | Rinderline Documentation</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Documentación Backend" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Documentación técnica del Backend de Rinderline" />
<meta property="og:description" content="Documentación técnica del Backend de Rinderline" />
<link rel="canonical" href="https://eddy3o.github.io/rinderline/rinderline/docs/01-backend.html" />
<meta property="og:url" content="https://eddy3o.github.io/rinderline/rinderline/docs/01-backend.html" />
<meta property="og:site_name" content="Rinderline Documentation" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Documentación Backend" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Documentación técnica del Backend de Rinderline","headline":"Documentación Backend","url":"https://eddy3o.github.io/rinderline/rinderline/docs/01-backend.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/rinderline/assets/css/style.css?v=e845fe252933680f1dec6f073d7565ad5f989349">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/rinderline/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="https://eddy3o.github.io/rinderline/rinderline/">Rinderline Documentation</a></h1>
      

      <h1 id="documentación-técnica---backend-de-rinderline">Documentación Técnica - Backend de Rinderline</h1>

<p><strong>Versión:</strong> 1.0<br />
<strong>Fecha:</strong> Noviembre 2025<br />
<strong>Framework:</strong> Django 5.2.8 + Django REST Framework 3.15.2 + PostgreSQL<br />
<strong>Stack:</strong> Python 3.11+ | Django ORM | Token Authentication<br />
<strong>Despliegue:</strong> Gunicorn + Nginx (Render/Railway) | AWS S3</p>

<hr />

<h2 id="índice">ÍNDICE</h2>

<ol>
  <li><a href="#1-introducción">Introducción Técnica</a></li>
  <li><a href="#2-arquitectura-general">Arquitectura General</a></li>
  <li><a href="#3-estructura-del-proyecto">Estructura del Proyecto</a></li>
  <li><a href="#4-modelos-y-base-de-datos">Modelos y Base de Datos</a></li>
  <li><a href="#5-api-y-endpoints">API y Endpoints</a></li>
  <li><a href="#6-autenticación-y-seguridad">Autenticación y Seguridad</a></li>
  <li><a href="#7-servicios-y-lógica-de-negocio">Servicios y Lógica de Negocio</a></li>
  <li><a href="#8-integraciones-externas">Integraciones Externas</a></li>
  <li><a href="#9-configuración-y-despliegue">Configuración y Despliegue</a></li>
  <li><a href="#10-troubleshooting-y-errores-comunes">Troubleshooting y Errores Comunes</a></li>
</ol>

<hr />

<h2 id="resumen-ejecutivo">RESUMEN EJECUTIVO</h2>

<p>El backend de Rinderline es una <strong>API REST monolítica construida con Django REST Framework</strong> que gestiona la lógica de negocio completa para la administración de gastos empresariales internacionales.</p>

<h3 id="características-clave">Características Clave:</h3>

<ul>
  <li><strong>Autenticación Token-based:</strong> Sin JWT, utilizando DRF Token Authentication con soporte para múltiples usuarios</li>
  <li><strong>Arquitectura de Capas:</strong> Views → Services → ORM → Database, con separación clara por features</li>
  <li><strong>Integraciones:</strong> AWS S3 (almacenamiento), SAP ERP (en desarrollo), APIs de tasas de cambio, Sentry (monitoreo)</li>
  <li><strong>Soft Delete:</strong> Eliminación lógica en documentos para auditoría completa</li>
</ul>

<h3 id="tecnologías">Tecnologías:</h3>

<ul>
  <li><strong>Backend:</strong> Python 3.11+, Django 5.2.8, DRF 3.15.2</li>
  <li><strong>BD:</strong> SQLite (dev), PostgreSQL (prod)</li>
  <li><strong>Autenticación:</strong> Token DRF (no JWT)</li>
  <li><strong>Almacenamiento:</strong> AWS S3</li>
  <li><strong>Monitoreo:</strong> Sentry + Prometheus</li>
  <li><strong>Despliegue:</strong> Gunicorn + Nginx + Render/Railway</li>
</ul>

<hr />

<h2 id="1-introducción">1. Introducción</h2>

<p><strong>Nota:</strong> Esta documentación cubre exclusivamente el backend de Rinderline; los detalles del frontend se documentan en su apartado correspondiente.</p>

<h3 id="11-objetivo-del-sistema">1.1 Objetivo del Sistema</h3>

<p>El backend de Rinderline está diseñado para ofrecer una API robusta y escalable que permita a las empresas gestionar sus gastos internacionales de forma eficiente y segura. Su principal objetivo es centralizar el registro, procesamiento y análisis de gastos —incluyendo viáticos, proveedores y aprobaciones multinivel— con soporte para múltiples monedas y corporativos.</p>

<h3 id="12-contexto-y-alcance-del-backend">1.2 Contexto y Alcance del Backend</h3>

<p>Dentro de la arquitectura de Rinderline, el backend cumple la función de:</p>

<ul>
  <li><strong>Exponer endpoints RESTful</strong> que implementan la lógica de negocio</li>
  <li><strong>Validar y almacenar datos</strong> en la base PostgreSQL</li>
  <li><strong>Gestionar autenticación y autorización</strong> mediante tokens seguros</li>
  <li><strong>Interactuar con servicios externos</strong> (SAP, AWS S3, APIs de tipo cambio)</li>
</ul>

<p>El alcance de esta documentación se centra únicamente en los componentes y procesos correspondientes al backend.</p>

<h3 id="13-separación-de-responsabilidades-con-el-frontend">1.3 Separación de Responsabilidades con el Frontend</h3>

<p>Para garantizar una arquitectura desacoplada y mantenible, además de escalable y pensada a futuro para su versión móvil, Rinderline sigue el patrón de separación clara de responsabilidades:</p>

<p><strong>Backend:</strong></p>

<ul>
  <li>Encargado de la lógica de negocio, almacenamiento de datos y seguridad</li>
  <li>Expone una API RESTful documentada con Swagger</li>
  <li>Maneja validaciones complejas y reglas de negocio</li>
</ul>

<p><strong>Frontend:</strong></p>

<ul>
  <li>Aplicación basada en Next.js que consume la API del backend</li>
  <li>Maneja la interfaz de usuario y experiencia del usuario</li>
  <li>Implementa validaciones de cliente y almacenamiento local</li>
</ul>

<p>Este enfoque facilita:</p>

<ul>
  <li>El desarrollo independiente de cada capa</li>
  <li>La evolución y escalabilidad de cada parte</li>
  <li>La mejora de la calidad del código al mantener responsabilidades bien delimitadas</li>
  <li>Facilita testing y debugging de forma aislada</li>
</ul>

<hr />

<h2 id="2-arquitectura-general">2. Arquitectura General</h2>

<h3 id="21-diagrama-general-del-sistema">2.1 Diagrama General del Sistema</h3>

<pre><code class="language-mermaid">flowchart TB
 subgraph Frontend["RINDERLINE FRONTEND"]
        A1["Login / Signup"]
        A2["Documents Management"]
        A3["Approvals System"]
        A4["Dashboard Analytics"]
  end
 subgraph Endpoints["API v1 Endpoints"]
        E1[/"api/v1/app/auth"/]
        E2[/"api/v1/app/documents"/]
        E3[/"api/v1/app/approvals"/]
        E4[/"api/v1/app/dashboards"/]
        E5[/"api/v1/app/sap"/]
        E6[/"api/v1/app/admin"/]
  end
 subgraph Middleware["Middleware &amp; Interceptors"]
        M1["CORS Handler"]
        M2["Token Authentication"]
        M3["Error Handler"]
        M4["Locale Middleware"]
  end
 subgraph Services["Services Layer"]
        S1["Dashboard Service"]
        S2["Approver Dashboard Service"]
        S3["AWS S3 File Store&lt;br&gt;- PDFs&lt;br&gt;- Documents&lt;br&gt;- Uploads"]
        S4["Document Builder"]
        S5["Exchange Rate Service"]
  end
 subgraph DAL["Data Access Layer"]
        D1["Django ORM Models"]
        D2["Query Optimization"]
        D3["Filtering &amp; Pagination"]
  end
 subgraph Backend["RINDERLINE BACKEND API"]
        Endpoints
        Middleware
        Services
        DAL
  end
 subgraph Storage["Storage"]
        DB["SQLite3 Database&lt;br&gt;- SQLAlchemy&lt;br&gt;- Models&lt;br&gt;- Relations&lt;br&gt;- Indexes"]
        APIs["External APIs&lt;br&gt;- Exchange Rates&lt;br&gt;- SAP ERP&lt;br&gt;- Sentry"]
  end
    A1 --&gt; Backend
    A2 --&gt; Backend
    A3 --&gt; Backend
    A4 --&gt; Backend
    Backend --&gt; Storage
</code></pre>

<hr />

<h3 id="22-componentes-principales">2.2 Componentes Principales</h3>

<h4 id="a-api-backend-django-rest-framework"><strong>A. API Backend (Django REST Framework)</strong></h4>

<p><strong>Tecnología:</strong> Django 5.2.8 + Django REST Framework 3.15.2</p>

<p><strong>Responsabilidades:</strong></p>

<ul>
  <li>Gestión de endpoints REST para todos los módulos</li>
  <li>Autenticación y autorización de usuarios</li>
  <li>Validación de datos de entrada</li>
  <li>Manejo de respuestas en formato JSend</li>
  <li>Integración con base de datos</li>
</ul>

<p><strong>Componentes:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rinderline/
├── settings.py           # Configuración principal de Django
├── urls.py               # Rutas principales de la API
├── wsgi.py               # WSGI para producción
└── asgi.py               # ASGI para desarrollo

app/
├── models.py             # Modelos de base de datos (19 modelos)
├── auth.py               # ViewSet de autenticación
├── renderers.py          # JSend Renderer personalizado
├── filters.py            # Filtros para queries
├── pagination.py         # Configuración de paginación
├── urls.py               # Rutas del app
├── permissions.py        # Permisos customizados
├── parsers.py            # Parsers para multipart/form-data
├── adapters/             # Adaptadores para servicios externos
├── builder/              # Patrón Builder para documentos
├── features/
│   ├── web/              # API endpoints públicos
│   │   ├── approvals/    # Endpoints de aprobaciones
│   │   ├── dashboards/   # Endpoints de dashboards
│   │   ├── documents/    # Endpoints de documentos
│   │   ├── info/         # Endpoints informativos
│   │   ├── reports/      # Endpoints de reportes
│   │   ├── sap/          # Integración SAP
│   │   └── serializers/  # Serializadores de datos
│   └── admin/            # API endpoints administrativos
├── services/             # Lógica de negocio
│   ├── dashboard_service.py
│   ├── approver_dashboard_service.py
│   └── appraisal_service.py
└── tests/                # Suite de pruebas
</code></pre></div></div>

<hr />

<h4 id="b-base-de-datos-sqlite3"><strong>B. Base de Datos (SQLite3)</strong></h4>

<p><strong>Tipo:</strong> SQLite3 (Desarrollo) / PostgreSQL (Producción)</p>

<p><strong>Modelos Principales:</strong></p>

<table>
  <thead>
    <tr>
      <th>Modelo</th>
      <th>Descripción</th>
      <th>Relaciones</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>User</strong></td>
      <td>Usuarios del sistema</td>
      <td>Company, Groups, Area</td>
    </tr>
    <tr>
      <td><strong>Company</strong></td>
      <td>Empresas/Organizaciones</td>
      <td>Groups, Currency</td>
    </tr>
    <tr>
      <td><strong>CostCenter</strong></td>
      <td>Centros de costo</td>
      <td>Company</td>
    </tr>
    <tr>
      <td><strong>Document</strong></td>
      <td>Documentos o informes</td>
      <td>User, Company, CostCenter</td>
    </tr>
    <tr>
      <td><strong>DocumentExpense</strong></td>
      <td>Gastos individuales</td>
      <td>Document, Supplier, Tax, Currency</td>
    </tr>
    <tr>
      <td><strong>DocumentTravel</strong></td>
      <td>Viajes</td>
      <td>Document, Route</td>
    </tr>
    <tr>
      <td><strong>DocumentPerDiem</strong></td>
      <td>Viáticos</td>
      <td>Document, PerDiem</td>
    </tr>
    <tr>
      <td><strong>ApprovalHistory</strong></td>
      <td>Historial de aprobaciones</td>
      <td>User, Document (Generic FK)</td>
    </tr>
    <tr>
      <td><strong>ExpenseFile</strong></td>
      <td>Archivos adjuntos</td>
      <td>DocumentExpense</td>
    </tr>
    <tr>
      <td><strong>Supplier</strong></td>
      <td>Proveedores</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>Area</strong></td>
      <td>Áreas de la empresa</td>
      <td>Company</td>
    </tr>
    <tr>
      <td><strong>Tax</strong></td>
      <td>Impuestos</td>
      <td>Company</td>
    </tr>
    <tr>
      <td><strong>ExpenseConcept</strong></td>
      <td>Conceptos de gasto</td>
      <td>Company</td>
    </tr>
    <tr>
      <td><strong>PerDiem</strong></td>
      <td>Viáticos configurables</td>
      <td>Company</td>
    </tr>
    <tr>
      <td><strong>Route</strong></td>
      <td>Rutas de viaje</td>
      <td>Company, Location</td>
    </tr>
    <tr>
      <td><strong>Currency</strong></td>
      <td>Monedas</td>
      <td>Company</td>
    </tr>
  </tbody>
</table>

<p><strong>Relaciones Clave:</strong></p>

<ul>
  <li>Relaciones de Foreign Key con <code class="language-plaintext highlighter-rouge">on_delete=models.PROTECT</code> (datos críticos)</li>
  <li>Relaciones Many-to-Many para permisos</li>
  <li>Generic Foreign Key para ApprovalHistory (polimorfismo)</li>
  <li>Soft delete (logical delete) en documents con campo <code class="language-plaintext highlighter-rouge">erased_at</code></li>
</ul>

<hr />

<h4 id="c-capa-de-servicios"><strong>C. Capa de Servicios</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/services/</code></p>

<p><strong>Servicios Disponibles:</strong></p>

<ol>
  <li>
    <p><strong>DashboardService</strong> (<code class="language-plaintext highlighter-rouge">dashboard_service.py</code>)</p>

    <ul>
      <li>Calcula resúmenes para empleados</li>
      <li>Agrupa documentos por estado</li>
      <li>Calcula totales y promedios</li>
    </ul>
  </li>
  <li>
    <p><strong>ApproverDashboardService</strong> (<code class="language-plaintext highlighter-rouge">approver_dashboard_service.py</code>)</p>

    <ul>
      <li>Dashboards para aprobadores por usuario</li>
      <li>Dashboards para aprobadores por centro de costo</li>
      <li>Dashboards para aprobadores por empresa</li>
    </ul>
  </li>
  <li>
    <p><strong>AppraisalService</strong> (<code class="language-plaintext highlighter-rouge">appraisal_service.py</code>)</p>
    <ul>
      <li>Lógica de aprobación</li>
      <li>Validación de niveles de aprobación</li>
      <li>Actualización de estados</li>
    </ul>
  </li>
</ol>

<hr />

<h4 id="d-capa-de-adaptadores"><strong>D. Capa de Adaptadores</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/adapters/</code></p>

<p><strong>Adaptadores Disponibles:</strong></p>

<ol>
  <li><strong>ExchangeRateService</strong>
    <ul>
      <li>Integración con API de tasas de cambio</li>
      <li>Conversión de divisas</li>
      <li>Caché de tasas</li>
    </ul>
  </li>
</ol>

<hr />

<h4 id="e-patrón-builder"><strong>E. Patrón Builder</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/builder/</code></p>

<p><strong>Propósito:</strong></p>

<ul>
  <li>Construcción compleja de documentos con múltiples items</li>
  <li>Validación y cálculo de totales</li>
  <li>Conversión de divisas</li>
  <li>Asociación de archivos</li>
</ul>

<p><strong>Método:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DocumentBuilder</span><span class="p">()</span>
    <span class="p">.</span><span class="n">create_document</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="p">.</span><span class="n">add_expense</span><span class="p">(</span><span class="n">expense_data</span><span class="p">)</span>
    <span class="p">.</span><span class="n">add_travel</span><span class="p">(</span><span class="n">travel_data</span><span class="p">)</span>
    <span class="p">.</span><span class="n">add_per_diem</span><span class="p">(</span><span class="n">per_diem_data</span><span class="p">)</span>
    <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h3 id="23-estilo-arquitectónico">2.3 Estilo Arquitectónico</h3>

<p><strong>Tipo:</strong> <strong>REST API Monolítica con Arquitectura de Capas</strong></p>

<h4 id="características"><strong>Características:</strong></h4>

<ol>
  <li>
    <p><strong>Estilo REST</strong></p>

    <ul>
      <li>Métodos HTTP estándar: GET, POST, PUT, PATCH, DELETE</li>
      <li>Recursos definidos (/documents, /approvals, etc.)</li>
      <li>Versionado en URL (/api/v1/)</li>
      <li>HATEOAS parcial (referencias en respuestas)</li>
    </ul>
  </li>
  <li>
    <p><strong>Arquitectura de Capas</strong></p>

    <pre><code class="language-mermaid">flowchart TB
 A["Presentation Layer&lt;br/&gt;(Views / ViewSets)"]
 B["Business Logic Layer&lt;br/&gt;(Services)"]
 C["Data Access Layer&lt;br/&gt;(Models / ORM)"]
 D["Database Layer&lt;br/&gt;(SQLite / PostgreSQL)"]

 A --&gt; B --&gt; C --&gt; D
</code></pre>
  </li>
  <li>
    <p><strong>Patrones Utilizados</strong></p>

    <ul>
      <li><strong>ViewSet Pattern</strong>: Manejo de CRUD con DRF</li>
      <li><strong>Builder Pattern</strong>: Construcción de documentos complejos</li>
      <li><strong>Adapter Pattern</strong>: Integración con servicios externos</li>
      <li><strong>Generic Foreign Key</strong>: Polimorfismo en ApprovalHistory</li>
    </ul>
  </li>
  <li>
    <p><strong>Aislamiento de Responsabilidades</strong></p>
    <ul>
      <li>Features: Separadas por dominio (web, admin)</li>
      <li>Serializers: Validación y transformación de datos</li>
      <li>Filters: Lógica de filtrado</li>
      <li>Permissions: Control de acceso</li>
    </ul>
  </li>
</ol>

<hr />

<h3 id="24-flujo-general-de-una-petición-request-lifecycle">2.4 Flujo General de una Petición (Request Lifecycle)</h3>

<h4 id="ciclo-completo-de-una-petición"><strong>Ciclo Completo de una Petición:</strong></h4>

<pre><code class="language-mermaid">flowchart TB

    %% CLIENT REQUEST
    A["**CLIENT REQUEST**&lt;br/&gt;POST /api/v1/app/documents/"]

    %% 1. URL ROUTING
    B["**1. DJANGO URL ROUTING**&lt;br/&gt;&lt;br/&gt;rinderline/urls.py → app/urls.py → features/web/urls.py&lt;br/&gt;Coincide con: path('documents/', DocumentListView.as_view())"]

    %% 2. MIDDLEWARE (REQUEST)
    C["**2. MIDDLEWARE PROCESSING (Request Phase)**&lt;br/&gt;&lt;br/&gt;✓ CorsMiddleware – Validar origen CORS&lt;br/&gt;✓ SecurityMiddleware – Headers de seguridad&lt;br/&gt;✓ SessionMiddleware – Sesión&lt;br/&gt;✓ AuthenticationMiddleware – Identificación&lt;br/&gt;✓ LocaleMiddleware – Idioma"]

    %% 3. VIEW/VIEWSET
    D["**3. VIEW/VIEWSET PROCESSING**&lt;br/&gt;&lt;br/&gt;DocumentListView.post(request)&lt;br/&gt;&lt;br/&gt;a) Autenticación: TokenAuthentication&lt;br/&gt;- Extraer token del header Authorization&lt;br/&gt;- Validar token en DB&lt;br/&gt;- Asignar request.user&lt;br/&gt;&lt;br/&gt;b) Permisos: IsAuthenticated&lt;br/&gt;- request.user debe existir&lt;br/&gt;&lt;br/&gt;c) Throttling: Anon/User Rate Throttle&lt;br/&gt;- Límite 1000 req/day&lt;br/&gt;&lt;br/&gt;d) Filtering: DjangoFilterBackend&lt;br/&gt;- Aplicar filtros"]

    %% 4. SERIALIZER VALIDATION
    E["**4. SERIALIZER VALIDATION**&lt;br/&gt;&lt;br/&gt;DocumentSerializer.is_valid()&lt;br/&gt;&lt;br/&gt;✓ Validar campos requeridos&lt;br/&gt;✓ Tipos de datos&lt;br/&gt;✓ Ranges (max_digits, decimal_places)&lt;br/&gt;✓ Validar Foreign Keys&lt;br/&gt;✓ Validadores custom&lt;br/&gt;&lt;br/&gt;Si falla → 400 Bad Request (JSend fail)"]

    %% 5. BUSINESS LOGIC (SERVICES)
    F["**5. BUSINESS LOGIC (Services Layer)**&lt;br/&gt;&lt;br/&gt;DocumentService.create_document()&lt;br/&gt;&lt;br/&gt;✓ Usar DocumentBuilder&lt;br/&gt;✓ Validar reglas de negocio&lt;br/&gt;✓ Conversiones de divisas&lt;br/&gt;✓ Auditoría si aplica&lt;br/&gt;✓ Notificaciones si aplica"]

    %% 6. ORM / DB OPERATIONS
    G["**6. DATABASE OPERATIONS (ORM Layer)**&lt;br/&gt;&lt;br/&gt;Document.objects.create(... )&lt;br/&gt;&lt;br/&gt;✓ Validaciones de modelo (clean())&lt;br/&gt;✓ Insertar en DB&lt;br/&gt;✓ Retornar objeto&lt;br/&gt;&lt;br/&gt;Si hay error → 500 Error"]

    %% 7. RESPONSE SERIALIZATION
    H["**7. RESPONSE SERIALIZATION**&lt;br/&gt;&lt;br/&gt;DocumentSerializer(document).data&lt;br/&gt;&lt;br/&gt;✓ Convertir objeto a dict&lt;br/&gt;✓ Campos permitidos&lt;br/&gt;✓ Relaciones anidadas&lt;br/&gt;✓ Transformaciones custom"]

    %% 8. RENDERER
    I["**8. RENDERER (JSendRenderer)**&lt;br/&gt;&lt;br/&gt;{&lt;br/&gt;  status: 'success',&lt;br/&gt;  data: { ... }&lt;br/&gt;}"]

    %% 9. MIDDLEWARE (RESPONSE)
    J["**9. MIDDLEWARE PROCESSING (Response Phase)**&lt;br/&gt;&lt;br/&gt;✓ CORS Headers&lt;br/&gt;✓ Security Headers&lt;br/&gt;✓ Content-Type JSON&lt;br/&gt;&lt;br/&gt;Response Headers:&lt;br/&gt;• Content-Type: application/json&lt;br/&gt;• Access-Control-Allow-Origin: https://frontend.com&lt;br/&gt;• X-Content-Type-Options: nosniff&lt;br/&gt;• X-Frame-Options: DENY"]

    %% FINAL RESPONSE
    K["**RESPONSE TO CLIENT**&lt;br/&gt;&lt;br/&gt;HTTP/1.1 201 Created&lt;br/&gt;Content-Type: application/json&lt;br/&gt;&lt;br/&gt;{ status: 'success', data: { id: 1, title: 'Gasto de viaje', ... } }"]

    %% FLOW CONNECTIONS
    A --&gt; B --&gt; C --&gt; D --&gt; E --&gt; F --&gt; G --&gt; H --&gt; I --&gt; J --&gt; K

</code></pre>

<hr />

<h4 id="casos-de-error-en-el-ciclo"><strong>Casos de Error en el Ciclo:</strong></h4>

<pre><code class="language-mermaid">flowchart TB

    %% ERROR 401 - INVALID TOKEN
    E401["**ERROR: Token No Válido**&lt;br/&gt;&lt;br/&gt;Status: 401 Unauthorized&lt;br/&gt;Fase: Authentication&lt;br/&gt;&lt;br/&gt;{&lt;br/&gt;  status: 'fail',&lt;br/&gt;  message: 'Invalid token'&lt;br/&gt;}"]

    %% ERROR 400 - VALIDATION ERROR
    E400["**ERROR: Validación de Datos**&lt;br/&gt;&lt;br/&gt;Status: 400 Bad Request&lt;br/&gt;Fase: Serializer Validation&lt;br/&gt;&lt;br/&gt;{&lt;br/&gt;  status: 'fail',&lt;br/&gt;  message: 'Validation error',&lt;br/&gt;  errors: {...}&lt;br/&gt;}"]

    %% ERROR 404 - NOT FOUND
    E404["**ERROR: Recurso No Encontrado**&lt;br/&gt;&lt;br/&gt;Status: 404 Not Found&lt;br/&gt;Fase: Database Query&lt;br/&gt;&lt;br/&gt;{&lt;br/&gt;  status: 'fail',&lt;br/&gt;  message: 'Document not found'&lt;br/&gt;}"]

    %% ERROR 500 - DATABASE ERROR
    E500["**ERROR: Error de Base de Datos**&lt;br/&gt;&lt;br/&gt;Status: 500 Internal Server Error&lt;br/&gt;Fase: Database Operations&lt;br/&gt;&lt;br/&gt;{&lt;br/&gt;  status: 'error',&lt;br/&gt;  message: 'An error occurred'&lt;br/&gt;}&lt;br/&gt;&lt;br/&gt;Log: Enviado a Sentry"]

    %% ORDER (optional)
    E401 --&gt; E400 --&gt; E404 --&gt; E500
</code></pre>

<hr />

<h3 id="25-integraciones-externas">2.5 Integraciones Externas</h3>

<h4 id="a-autenticación-token-based"><strong>A. Autenticación (Token-Based)</strong></h4>

<p><strong>Implementación:</strong> Django Rest Framework Token Authentication</p>

<p><strong>Flujo:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Usuario hace login
   POST /api/v1/app/auth/login/
   Body: {"username": "...", "password": "..."}

2. Backend valida credenciales contra modelo User
3. Backend genera/recupera Token
4. Respuesta: {"token": "abc123def456..."}

5. Cliente almacena token en localStorage/sessionStorage

6. Peticiones posteriores incluyen token:
   GET /api/v1/app/documents/
   Headers: Authorization: Token abc123def456...

7. Backend valida token y asocia a usuario
</code></pre></div></div>

<p><strong>Características:</strong></p>

<ul>
  <li>Tokens almacenados en tabla <code class="language-plaintext highlighter-rouge">authtoken_token</code></li>
  <li>1 token por usuario (se reemplaza al login)</li>
  <li>Sin expiración en el código (se puede agregar)</li>
  <li>Logout elimina el token</li>
</ul>

<hr />

<h4 id="b-api-de-tasas-de-cambio"><strong>B. API de Tasas de Cambio</strong></h4>

<p><strong>Servicio:</strong> ExchangeRateService (<code class="language-plaintext highlighter-rouge">app/adapters/adapters.py</code>)</p>

<p><strong>Propósito:</strong> Convertir montos entre divisas</p>

<p><strong>Flujo:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Al crear DocumentExpense con currency ≠ base_currency
2. ExchangeRateService obtiene tasa de cambio
3. Calcula: converted_amount = original_amount / exchange_rate
4. Guarda ambos valores en DB

Métodos:
- get_rate(from_currency, to_currency) → float
- convert(amount, from_currency, to_currency) → float
</code></pre></div></div>

<hr />

<h4 id="c-almacenamiento-en-aws-s3"><strong>C. Almacenamiento en AWS S3</strong></h4>

<p><strong>Configuración:</strong> STORAGES en settings.py</p>

<p><strong>Uso:</strong></p>

<ul>
  <li>Documentos PDF (field: Document.file)</li>
  <li>Archivos de gastos (ExpenseFile)</li>
</ul>

<p><strong>Configuración:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AWS_STORAGE_BUCKET_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_STORAGE_BUCKET_NAME'</span><span class="p">)</span>
<span class="n">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_ACCESS_KEY_ID'</span><span class="p">)</span>
<span class="n">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_SECRET_ACCESS_KEY'</span><span class="p">)</span>
<span class="n">AWS_S3_CUSTOM_DOMAIN</span> <span class="o">=</span> <span class="s">'bucket-name.s3.amazonaws.com'</span>
</code></pre></div></div>

<p><strong>Rutas:</strong></p>

<ul>
  <li>Documentos: <code class="language-plaintext highlighter-rouge">documents/{year}/{month}/{filename}</code></li>
</ul>

<hr />

<h4 id="d-integración-sap-erp-en-desarrollo"><strong>D. Integración SAP ERP (en desarrollo)</strong></h4>

<p><strong>Endpoints:</strong></p>

<ul>
  <li>GET <code class="language-plaintext highlighter-rouge">/api/v1/app/sap/documents/</code> - Listar documentos en SAP</li>
  <li>POST <code class="language-plaintext highlighter-rouge">/api/v1/app/sap/documents/send/</code> - Enviar documento a SAP</li>
</ul>

<p><strong>Flujo:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Usuario completa documento en Rinderline
2. Usuario aprueba y marca para enviar
3. Sistema convierte documento a formato SAP
4. Envía datos a API SAP
5. SAP confirma recepción
6. Sistema guarda external_code de SAP
</code></pre></div></div>

<p><strong>Formato de Integración:</strong> Por definir (JSON, XML, SOAP, etc.)</p>

<hr />

<h4 id="e-monitoreo-y-logging-sentry"><strong>E. Monitoreo y Logging (Sentry)</strong></h4>

<p><strong>Configuración:</strong> <code class="language-plaintext highlighter-rouge">django_sentry</code> (puede agregarse)</p>

<p><strong>Captura:</strong></p>

<ul>
  <li>Excepciones no manejadas</li>
  <li>Errores 500+</li>
  <li>Errores de base de datos</li>
  <li>Timeouts</li>
</ul>

<p><strong>Propósito:</strong></p>

<ul>
  <li>Alertas en tiempo real</li>
  <li>Tracking de errores</li>
  <li>Stack traces completos</li>
</ul>

<hr />

<h4 id="f-email-futuro"><strong>F. Email (Futuro)</strong></h4>

<p><strong>Servicio:</strong> Django Email Backend (por configurar)</p>

<p><strong>Casos de Uso:</strong></p>

<ul>
  <li>Notificación de documentos pendientes de aprobación</li>
  <li>Confirmación de aprobación/rechazo</li>
  <li>Recordatorios de vencimientos</li>
</ul>

<hr />

<h4 id="g-análisis-y-métricas-prometheus"><strong>G. Análisis y Métricas (Prometheus)</strong></h4>

<p><strong>Instalado:</strong> <code class="language-plaintext highlighter-rouge">django-prometheus</code> en requirements.txt</p>

<p><strong>Endpoints:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/metrics</code> - Métricas Prometheus</li>
  <li>Recolecta: Latencias, requests, errores, etc.</li>
</ul>

<hr />

<h2 id="resumen-de-arquitectura">Resumen de Arquitectura</h2>

<table>
  <thead>
    <tr>
      <th>Aspecto</th>
      <th>Implementación</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Patrón Arquitectónico</strong></td>
      <td>Monolito con capas (MVC)</td>
    </tr>
    <tr>
      <td><strong>Estilo API</strong></td>
      <td>REST con JSend</td>
    </tr>
    <tr>
      <td><strong>Autenticación</strong></td>
      <td>Token (DRF)</td>
    </tr>
    <tr>
      <td><strong>Base de Datos</strong></td>
      <td>SQLite (Dev) / PostgreSQL (Prod)</td>
    </tr>
    <tr>
      <td><strong>ORM</strong></td>
      <td>Django ORM</td>
    </tr>
    <tr>
      <td><strong>Validación</strong></td>
      <td>Serializers + Model validation</td>
    </tr>
    <tr>
      <td><strong>Almacenamiento</strong></td>
      <td>AWS S3</td>
    </tr>
    <tr>
      <td><strong>Cache</strong></td>
      <td>Por implementar</td>
    </tr>
    <tr>
      <td><strong>Cola de Tareas</strong></td>
      <td>Por implementar (Celery)</td>
    </tr>
    <tr>
      <td><strong>Logging</strong></td>
      <td>Django + Sentry</td>
    </tr>
    <tr>
      <td><strong>Monitoreo</strong></td>
      <td>Prometheus</td>
    </tr>
    <tr>
      <td><strong>Despliegue</strong></td>
      <td>Gunicorn + Nginx (Render/Railway)</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="3-estructura-del-proyecto">3. Estructura del Proyecto</h2>

<h3 id="31-estructura-de-carpetas">3.1 Estructura de Carpetas</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rinderline_backend/rinderline/
│
├── rinderline/                    # Configuración del proyecto
│   ├── settings.py               # Configuración de Django (DEBUG, DATABASES, APPS, etc.)
│   ├── urls.py                   # Rutas principales (API v1, admin, swagger)
│   ├── wsgi.py                   # Entry point para producción (Gunicorn)
│   ├── asgi.py                   # Entry point para desarrollo (Uvicorn)
│   └── __pycache__/
│
├── app/                           # Aplicación principal
│   ├── models.py                 # 19 modelos de Django ORM
│   ├── auth.py                   # ViewSet de autenticación (login, register, logout)
│   ├── admin.py                  # Configuración de Django Admin
│   ├── apps.py                   # Configuración de la app
│   ├── urls.py                   # URLs raíz del app
│   ├── renderers.py              # JSendRenderer personalizado
│   ├── filters.py                # Filtros para queries (DocumentFilter, ItemsFilter)
│   ├── pagination.py             # Configuración de paginación (SmallPagination)
│   ├── parsers.py                # Parser multipart/form-data restructure_multipart()
│   ├── forms.py                  # Formularios Django (validación)
│   ├── __init__.py
│   │
│   ├── adapters/                 # Patrón Adapter para servicios externos
│   │   ├── adapters.py           # ExchangeRateService
│   │   └── __pycache__/
│   │
│   ├── builder/                  # Patrón Builder para documentos complejos
│   │   ├── builder.py            # Clase DocumentBuilder
│   │   ├── use_cases.py          # Use Cases (CreateDocument, AddExpense, etc.)
│   │   └── __pycache__/
│   │
│   ├── features/                 # Separación de features por dominio
│   │   ├── web/                  # API endpoints públicos (usuarios normales)
│   │   │   ├── urls.py           # Rutas de web features
│   │   │   ├── permissions.py    # Permisos customizados
│   │   │   │
│   │   │   ├── approvals/        # Feature: Aprobaciones
│   │   │   │   └── views.py      # Views: Pending, History, Update
│   │   │   │
│   │   │   ├── dashboards/       # Feature: Dashboards
│   │   │   │   └── views.py      # Views: Employee, UserApprover, etc.
│   │   │   │
│   │   │   ├── documents/        # Feature: Documentos
│   │   │   │   └── views.py      # Views: List, Detail, Items
│   │   │   │
│   │   │   ├── info/             # Feature: Información general
│   │   │   │   └── views.py      # Views: Test, User, Profile, Suppliers
│   │   │   │
│   │   │   ├── reports/          # Feature: Reportes
│   │   │   │   └── views.py      # Views: Upload, Delete Status
│   │   │   │
│   │   │   ├── sap/              # Feature: Integración SAP
│   │   │   │   └── views.py      # Views: SAP Documents, SAP Post
│   │   │   │
│   │   │   └── serializers/      # Serializadores (validación y transformación)
│   │   │       ├── serializers.py   # Serializers principales
│   │   │       ├── approvals.py     # Serializadores de aprobaciones
│   │   │       ├── common.py        # Serializadores comunes
│   │   │       ├── documents.py     # Serializadores de documentos
│   │   │       ├── items.py         # Serializadores de items
│   │   │       ├── sap.py           # Serializadores SAP
│   │   │       └── __pycache__/
│   │   │
│   │   └── admin/                # API endpoints administrativos
│   │       ├── urls.py           # Rutas de admin features
│   │       ├── admin.py          # Configuración y registros
│   │       ├── serializers.py    # Serializadores admin
│   │       └── __pycache__/
│   │
│   ├── services/                 # Capa de servicios (lógica de negocio)
│   │   ├── dashboard_service.py           # Cálculos de dashboard empleado
│   │   ├── approver_dashboard_service.py  # Cálculos de dashboard aprobador
│   │   ├── appraisal_service.py           # Lógica de aprobación
│   │   └── __pycache__/
│   │
│   ├── migrations/               # Migraciones de base de datos
│   │   ├── 0001_initial.py
│   │   ├── 0002_groups_rename_user_approvalhistory_approver_and_more.py
│   │   ├── ... (más migraciones)
│   │   └── __pycache__/
│   │
│   ├── tests/                    # Suite de pruebas
│   │   ├── test_*.py
│   │   └── __pycache__/
│   │
│   └── __pycache__/
│
├── locale/                        # Internacionalización (i18n)
│   ├── de/
│   │   └── LC_MESSAGES/
│   ├── en/
│   │   └── LC_MESSAGES/
│   ├── es/
│   │   └── LC_MESSAGES/
│   └── fr/
│       └── LC_MESSAGES/
│
├── stylescss/                     # Estilos estáticos
│   └── admin/
│
├── templates/                     # Plantillas HTML (Django Admin)
│   └── admin/
│
├── venv/                          # Virtual environment (no versionado)
│
├── .env                           # Variables de entorno (no versionado)
├── db.sqlite3                     # Base de datos SQLite (no versionado)
├── manage.py                      # CLI de Django
├── build.sh                       # Script de build para producción
├── requirements.txt               # Dependencias de Python
└── README.md                      # Documentación del proyecto
</code></pre></div></div>

<hr />

<h3 id="32-explicación-de-módulos-clave">3.2 Explicación de Módulos Clave</h3>

<h4 id="a-rinderline-configuración"><strong>A. rinderline/ (Configuración)</strong></h4>

<table>
  <thead>
    <tr>
      <th>Archivo</th>
      <th>Responsabilidad</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">settings.py</code></td>
      <td>Configuración global: DEBUG, ALLOWED_HOSTS, DATABASES, INSTALLED_APPS, MIDDLEWARE, AUTH, CORS, AWS, etc.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">urls.py</code></td>
      <td>Rutas principales: <code class="language-plaintext highlighter-rouge">/admin/</code>, <code class="language-plaintext highlighter-rouge">/api/v1/app/</code>, <code class="language-plaintext highlighter-rouge">/api/v1/app/swagger/</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">wsgi.py</code></td>
      <td>WSGI para servidores como Gunicorn (producción)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">asgi.py</code></td>
      <td>ASGI para servidores async como Uvicorn (desarrollo)</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="b-app-aplicación-principal"><strong>B. app/ (Aplicación Principal)</strong></h4>

<table>
  <thead>
    <tr>
      <th>Módulo</th>
      <th>Responsabilidad</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">models.py</code></td>
      <td>Definición de 19 modelos ORM (User, Company, Document, etc.)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">auth.py</code></td>
      <td>ViewSet REST para login, register, logout con Token Auth</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">admin.py</code></td>
      <td>Registros en Django Admin con filtros y permisos por grupo</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">filters.py</code></td>
      <td>Filtros DjangoFilter para búsqueda y filtrado de documentos</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pagination.py</code></td>
      <td>Configuración de paginación (15 items por página)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">renderers.py</code></td>
      <td>Custom renderer JSend para respuestas estándar</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">parsers.py</code></td>
      <td>Parser para multipart/form-data con arrays anidados</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="c-appadapters-servicios-externos"><strong>C. app/adapters/ (Servicios Externos)</strong></h4>

<p><strong>ExchangeRateService</strong></p>

<ul>
  <li>Obtiene tasas de cambio de API externa</li>
  <li>Convierte montos entre monedas</li>
  <li>Integración con DocumentBuilder</li>
</ul>

<hr />

<h4 id="d-appbuilder-patrón-builder"><strong>D. app/builder/ (Patrón Builder)</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>builder.py
├── DocumentBuilder           # Clase que implementa el patrón Builder
│   ├── create_document()     # Crea documento base
│   ├── add_expense()         # Agrega gasto
│   ├── add_travel()          # Agrega viaje
│   ├── add_per_diem()        # Agrega viático
│   └── build()               # Retorna documento construido
│
use_cases.py
├── CreateDocumentUseCase
├── AddExpenseToDocumentUseCase
├── AddTravelToDocumentUseCase
└── AddPerDiemToDocumentUseCase
</code></pre></div></div>

<hr />

<h4 id="e-appfeatures-separación-por-dominio"><strong>E. app/features/ (Separación por Dominio)</strong></h4>

<p><strong>Estructura de Feature:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>feature/
├── views.py              # ViewSets/Views REST
├── urls.py               # Rutas específicas
├── serializers/          # Serializadores
│   ├── serializers.py    # Serializadores comunes
│   └── specific.py       # Serializadores específicos
├── permissions.py        # Permisos customizados
└── __pycache__/
</code></pre></div></div>

<p><strong>Features Disponibles:</strong></p>

<ol>
  <li>
    <p><strong>web/approvals/</strong> - Gestión de aprobaciones</p>

    <ul>
      <li>Listar pendientes</li>
      <li>Historial de aprobaciones</li>
      <li>Actualizar estado de gastos/viajes/viáticos</li>
    </ul>
  </li>
  <li>
    <p><strong>web/dashboards/</strong> - Dashboards e informes</p>

    <ul>
      <li>Dashboard empleado</li>
      <li>Dashboard aprobador por usuario</li>
      <li>Dashboard aprobador por centro de costo</li>
      <li>Dashboard aprobador por empresa</li>
    </ul>
  </li>
  <li>
    <p><strong>web/documents/</strong> - Gestión de documentos</p>

    <ul>
      <li>Listar documentos</li>
      <li>Detalle de documento</li>
      <li>Items de documento</li>
    </ul>
  </li>
  <li>
    <p><strong>web/info/</strong> - Información general</p>

    <ul>
      <li>Perfil de usuario</li>
      <li>Información de empresa</li>
      <li>Proveedores</li>
      <li>Reportes</li>
    </ul>
  </li>
  <li>
    <p><strong>web/reports/</strong> - Reportes</p>

    <ul>
      <li>Subir reportes</li>
      <li>Eliminar lógico de reportes</li>
    </ul>
  </li>
  <li>
    <p><strong>web/sap/</strong> - Integración SAP</p>

    <ul>
      <li>Listar documentos en SAP</li>
      <li>Enviar documentos a SAP</li>
    </ul>
  </li>
  <li>
    <p><strong>admin/</strong> - Endpoints administrativos</p>
    <ul>
      <li>Gestión de usuarios</li>
      <li>Gestión de configuración</li>
    </ul>
  </li>
</ol>

<hr />

<h4 id="f-appservices-lógica-de-negocio"><strong>F. app/services/ (Lógica de Negocio)</strong></h4>

<p><strong>DashboardService</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_employee_dashboard</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="c1"># Agrupa documentos por estado
</span>    <span class="c1"># Calcula totales y promedios
</span>    <span class="c1"># Retorna resumen para dashboard
</span></code></pre></div></div>

<p><strong>ApproverDashboardService</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_approver_dashboard_user</span><span class="p">(</span><span class="n">approver</span><span class="p">):</span>
    <span class="c1"># Documentos pendientes de aprobación
</span>    <span class="c1"># Agrupados por usuario
</span>
<span class="k">def</span> <span class="nf">get_approver_dashboard_cost_center</span><span class="p">(</span><span class="n">approver</span><span class="p">):</span>
    <span class="c1"># Documentos pendientes de aprobación
</span>    <span class="c1"># Agrupados por centro de costo
</span>
<span class="k">def</span> <span class="nf">get_approver_dashboard_company</span><span class="p">(</span><span class="n">approver</span><span class="p">):</span>
    <span class="c1"># Documentos pendientes de aprobación
</span>    <span class="c1"># Agrupados por empresa
</span></code></pre></div></div>

<p><strong>AppraisalService</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">approve_expense</span><span class="p">(</span><span class="n">expense</span><span class="p">,</span> <span class="n">approver</span><span class="p">,</span> <span class="n">comments</span><span class="p">):</span>
    <span class="c1"># Valida que approver tiene permisos
</span>    <span class="c1"># Actualiza estado a APPROVED
</span>    <span class="c1"># Crea registro de ApprovalHistory
</span>
<span class="k">def</span> <span class="nf">reject_expense</span><span class="p">(</span><span class="n">expense</span><span class="p">,</span> <span class="n">approver</span><span class="p">,</span> <span class="n">comments</span><span class="p">):</span>
    <span class="c1"># Valida que approver tiene permisos
</span>    <span class="c1"># Actualiza estado a REJECTED
</span>    <span class="c1"># Crea registro de ApprovalHistory
</span></code></pre></div></div>

<hr />

<h4 id="g-appserializers-validación-y-transformación"><strong>G. app/serializers/ (Validación y Transformación)</strong></h4>

<p>Estructura de serializadores:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># common.py - Serializadores comunes
</span><span class="k">class</span> <span class="nc">UserSerializer</span>
<span class="k">class</span> <span class="nc">CompanySerializer</span>
<span class="k">class</span> <span class="nc">CostCenterSerializer</span>

<span class="c1"># documents.py - Serializadores de documentos
</span><span class="k">class</span> <span class="nc">DocumentSerializer</span>
<span class="k">class</span> <span class="nc">DocumentListSerializer</span>
<span class="k">class</span> <span class="nc">DocumentDetailSerializer</span>

<span class="c1"># items.py - Serializadores de items
</span><span class="k">class</span> <span class="nc">DocumentExpenseSerializer</span>
<span class="k">class</span> <span class="nc">DocumentTravelSerializer</span>
<span class="k">class</span> <span class="nc">DocumentPerDiemSerializer</span>
<span class="k">class</span> <span class="nc">ExpenseFileSerializer</span>

<span class="c1"># approvals.py - Serializadores de aprobaciones
</span><span class="k">class</span> <span class="nc">ApprovalHistorySerializer</span>
<span class="k">class</span> <span class="nc">ApprovalUpdateSerializer</span>

<span class="c1"># sap.py - Serializadores SAP
</span><span class="k">class</span> <span class="nc">SapDocumentSerializer</span>
</code></pre></div></div>

<hr />

<h3 id="33-convenciones-de-nombres-y-estilos">3.3 Convenciones de Nombres y Estilos</h3>

<h4 id="a-nomenclatura-de-modelos"><strong>A. Nomenclatura de Modelos</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>✓ User (no Users)
✓ Company (no Companies)
✓ Document (no Documents)
✓ DocumentExpense (no ExpenseDocument)
✓ ApprovalHistory (no ApprovalHistories)
</code></pre></div></div>

<p><strong>Reglas:</strong></p>

<ul>
  <li>Singular</li>
  <li>PascalCase</li>
  <li>Descriptivo del dominio</li>
</ul>

<hr />

<h4 id="b-nomenclatura-de-viewsets"><strong>B. Nomenclatura de ViewSets</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>✓ DocumentListView          # Para listar y crear
✓ DocumentDetailView        # Para retrieve, update, delete
✓ ApprovalPendingListView   # Para listar pendientes
✓ Auth (ViewSet)            # Para acciones especiales (login, register)
</code></pre></div></div>

<p><strong>Convención:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">{Model}ListView</code> para GET list y POST create</li>
  <li><code class="language-plaintext highlighter-rouge">{Model}DetailView</code> para GET detail, PUT/PATCH, DELETE</li>
  <li><code class="language-plaintext highlighter-rouge">{Action}{Entity}View</code> para vistas específicas</li>
  <li>Heredan de <code class="language-plaintext highlighter-rouge">generics.ListAPIView</code>, <code class="language-plaintext highlighter-rouge">generics.RetrieveUpdateAPIView</code>, etc.</li>
</ul>

<hr />

<h4 id="c-nomenclatura-de-urls"><strong>C. Nomenclatura de URLs</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>✓ /api/v1/app/documents/                     # List/Create
✓ /api/v1/app/documents/&lt;int:pk&gt;/            # Detail/Update/Delete
✓ /api/v1/app/documents/&lt;int:pk&gt;/items/      # Sub-recursos
✓ /api/v1/app/documents/&lt;int:pk&gt;/delete/     # Acciones POST custom
✓ /api/v1/app/approvals/pending/             # Listados filtrados
</code></pre></div></div>

<p><strong>Convención:</strong></p>

<ul>
  <li>Versionado en URL (<code class="language-plaintext highlighter-rouge">/api/v1/</code>)</li>
  <li>Recursos en plural</li>
  <li>Sub-recursos anidados</li>
  <li>Acciones custom como sub-rutas POST</li>
</ul>

<hr />

<h4 id="d-nomenclatura-de-serializers"><strong>D. Nomenclatura de Serializers</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>✓ DocumentSerializer          # Para create/update
✓ DocumentListSerializer      # Para list (campos limitados)
✓ DocumentDetailSerializer    # Para detail (campos completos)
✓ DocumentApprovalSerializer  # Para contexto específico
</code></pre></div></div>

<p><strong>Convención:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">{Model}Serializer</code> para CRUD completo</li>
  <li><code class="language-plaintext highlighter-rouge">{Model}{Action}Serializer</code> para acciones específicas</li>
  <li>Separados en archivos por feature</li>
</ul>

<hr />

<h4 id="e-estilo-de-código-python"><strong>E. Estilo de Código Python</strong></h4>

<p><strong>PEP 8 Compliance:</strong></p>

<ul>
  <li>4 espacios de indentación</li>
  <li>Máximo 79 caracteres por línea (docstrings 72)</li>
  <li>Nombres de variables: <code class="language-plaintext highlighter-rouge">snake_case</code></li>
  <li>Nombres de constantes: <code class="language-plaintext highlighter-rouge">UPPER_CASE</code></li>
  <li>Nombres de clases: <code class="language-plaintext highlighter-rouge">PascalCase</code></li>
</ul>

<p><strong>Ejemplo:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DocumentSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="s">"""Serializador para Document model con validación custom."""</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cost_center</span> <span class="o">=</span> <span class="n">CostCenterSerializer</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">,</span> <span class="s">'state'</span><span class="p">,</span> <span class="s">'user'</span><span class="p">,</span> <span class="s">'cost_center'</span><span class="p">]</span>
        <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'created_at'</span><span class="p">,</span> <span class="s">'updated_at'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">"""Validar que el título no esté vacío."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"El título no puede estar vacío."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div>

<hr />

<h4 id="f-estilo-de-api-responses"><strong>F. Estilo de API Responses</strong></h4>

<p><strong>Éxito (JSend):</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gasto de viaje"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SAVED"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Error de Validación:</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fail"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Validation error"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Este campo es requerido."</span><span class="p">],</span><span class="w">
    </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Este valor debe ser un decimal válido."</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Error de Servidor:</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"error"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"An error occurred"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h3 id="34-dependencias-y-librerías-importantes">3.4 Dependencias y Librerías Importantes</h3>

<h4 id="a-framework-y-orm"><strong>A. Framework y ORM</strong></h4>

<table>
  <thead>
    <tr>
      <th>Paquete</th>
      <th>Versión</th>
      <th>Propósito</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Django</td>
      <td>5.2.8</td>
      <td>Framework web</td>
    </tr>
    <tr>
      <td>djangorestframework</td>
      <td>3.15.2</td>
      <td>REST API</td>
    </tr>
    <tr>
      <td>psycopg2-binary</td>
      <td>2.9.10</td>
      <td>Driver PostgreSQL</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="b-autenticación-y-autorización"><strong>B. Autenticación y Autorización</strong></h4>

<table>
  <thead>
    <tr>
      <th>Paquete</th>
      <th>Versión</th>
      <th>Propósito</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>rest_framework.authtoken</td>
      <td>Incluido en DRF</td>
      <td>Token authentication</td>
    </tr>
    <tr>
      <td>django-cors-headers</td>
      <td>4.4.0</td>
      <td>CORS handling</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="c-documentación-y-validación"><strong>C. Documentación y Validación</strong></h4>

<table>
  <thead>
    <tr>
      <th>Paquete</th>
      <th>Versión</th>
      <th>Propósito</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>drf-yasg</td>
      <td>1.21.8</td>
      <td>Documentación Swagger/OpenAPI</td>
    </tr>
    <tr>
      <td>PyYAML</td>
      <td>6.0.2</td>
      <td>Parsing YAML</td>
    </tr>
    <tr>
      <td>django-filter</td>
      <td>25.2</td>
      <td>Filtrado de queries</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="d-almacenamiento"><strong>D. Almacenamiento</strong></h4>

<table>
  <thead>
    <tr>
      <th>Paquete</th>
      <th>Versión</th>
      <th>Propósito</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>django-storages</td>
      <td>1.14.4</td>
      <td>Backend S3</td>
    </tr>
    <tr>
      <td>boto3</td>
      <td>1.36.16</td>
      <td>Cliente AWS SDK</td>
    </tr>
    <tr>
      <td>s3transfer</td>
      <td>0.11.2</td>
      <td>Transferencias S3</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="e-monitoreo-y-logging"><strong>E. Monitoreo y Logging</strong></h4>

<table>
  <thead>
    <tr>
      <th>Paquete</th>
      <th>Versión</th>
      <th>Propósito</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>sentry-sdk</td>
      <td>1.32.0</td>
      <td>Error tracking</td>
    </tr>
    <tr>
      <td>django-prometheus</td>
      <td>2.3.1</td>
      <td>Métricas Prometheus</td>
    </tr>
    <tr>
      <td>prometheus-client</td>
      <td>0.17.1</td>
      <td>Cliente Prometheus</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="f-utilidades"><strong>F. Utilidades</strong></h4>

<table>
  <thead>
    <tr>
      <th>Paquete</th>
      <th>Versión</th>
      <th>Propósito</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>python-dotenv</td>
      <td>1.0.1</td>
      <td>Variables de entorno</td>
    </tr>
    <tr>
      <td>requests</td>
      <td>2.32.3</td>
      <td>Cliente HTTP</td>
    </tr>
    <tr>
      <td>python-dateutil</td>
      <td>2.9.0.post0</td>
      <td>Manejo de fechas</td>
    </tr>
    <tr>
      <td>pytz</td>
      <td>2025.1</td>
      <td>Zonas horarias</td>
    </tr>
  </tbody>
</table>

<hr />

<h4 id="g-producción"><strong>G. Producción</strong></h4>

<table>
  <thead>
    <tr>
      <th>Paquete</th>
      <th>Versión</th>
      <th>Propósito</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>gunicorn</td>
      <td>23.0.0</td>
      <td>WSGI server</td>
    </tr>
    <tr>
      <td>whitenoise</td>
      <td>6.7.0</td>
      <td>Servir archivos estáticos</td>
    </tr>
    <tr>
      <td>uvicorn</td>
      <td>0.32.0</td>
      <td>ASGI server</td>
    </tr>
    <tr>
      <td>dj-database-url</td>
      <td>2.3.0</td>
      <td>Parsing URL de DB</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="resumen-de-estructura">Resumen de Estructura</h2>

<table>
  <thead>
    <tr>
      <th>Aspecto</th>
      <th>Detalle</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Tipo de Proyecto</strong></td>
      <td>Django REST API</td>
    </tr>
    <tr>
      <td><strong>Patrón</strong></td>
      <td>MVC (Models, Views, Controllers/Serializers)</td>
    </tr>
    <tr>
      <td><strong>Organización</strong></td>
      <td>Por features + servicios</td>
    </tr>
    <tr>
      <td><strong>Documentación API</strong></td>
      <td>Swagger + OpenAPI (drf-yasg)</td>
    </tr>
    <tr>
      <td><strong>Testing</strong></td>
      <td>Por implementar</td>
    </tr>
    <tr>
      <td><strong>Linting</strong></td>
      <td>Por implementar (recomendado: black, flake8)</td>
    </tr>
    <tr>
      <td><strong>Validación</strong></td>
      <td>Serializers + Modelo</td>
    </tr>
    <tr>
      <td><strong>Autenticación</strong></td>
      <td>Token based</td>
    </tr>
    <tr>
      <td><strong>Almacenamiento</strong></td>
      <td>AWS S3 + SQLite/PostgreSQL</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="4-modelos-y-base-de-datos">4. Modelos y Base de Datos</h2>

<h3 id="41-diagrama-entidad-relación-er">4.1 Diagrama Entidad-Relación (ER)</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─────────────┐              ┌────────────────┐
│   Groups    │◄─────────────┤   Company      │
│             │ FK           │                │
│ - id (PK)   │              │ - id (PK)      │
│ - name      │              │ - name (UQ)    │
└─────────────┘              │ - rut (UQ)     │
      ▲                       │ - address      │
      │ M2M                   │ - email        │
      │                       │ - sap_code     │
      │                       │ - clvct        │
      │                       │ - base_currency(FK)
      │                       └────────────────┘
      │                              ▲
      │                              │ 1
      │                        ┌─────┴──────┐
      │                        │            │
┌──────┴──────┐          ┌─────▼────┐ ┌──────▼────┐
│   User      │          │ Currency │ │CostCenter │
│             │          │          │ │           │
│ - id (PK)   │          │ - id(PK) │ │ - id(PK)  │
│ - username  │          │ - name   │ │ - name(UQ)│
│ - rut (UQ)  │          │ - comments   │ - code(UQ)│
│ - role      │          └──────────┘ │ - company │
│ - company   │                         └───────────┘
│ - area      │                              ▲
│ - password  │                              │ 1
└─────────────┘                              │
      │                                      │
      │ 1                        ┌───────────┴─────────────┐
      │                          │ N                     N │
      ▼ N                 ┌──────▼────────┐      ┌────────▼──────┐
┌────────────────────┐    │  Document    │      │    Access    │
│ UserApprover       │    │              │      │              │
│ - user (FK)        │    │ - id (PK)    │      │ - user (FK)  │
│ - can_approve_for  │    │ - title      │      │ - costcenter │
│   (M2M User)       │    │ - state      │      │   (FK)       │
└────────────────────┘    │ - enterprise │      │ - comments   │
                          │   (FK)       │      └──────────────┘
┌──────────────────────┐  │ - user (FK)  │
│CostCenterApprover    │  │ - cost_center│      ┌──────────────┐
│ - user (FK)          │  │   (FK)       │      │     Area     │
│ - cost_center        │  │ - file       │      │              │
│   (M2M CostCenter)   │  │ - paid       │      │ - id (PK)    │
└──────────────────────┘  │ - erased_at  │      │ - name       │
                          │ - created_at │      │ - company(FK)│
┌──────────────────────┐  │ - updated_at │      └──────────────┘
│ CompanyApprover      │  └──────────────┘
│ - user (FK)          │         ▲
│ - company            │         │ 1
│   (M2M Company)      │         │
└──────────────────────┘         │
                                 │ N
        ┌────────────────────────┼────────────────┬──────────────┐
        │                        │                │              │
   ┌────▼──────────┐      ┌──────▼─────────┐ ┌──▼──────────┐ ┌──▼──────────┐
   │DocumentExpense│      │DocumentTravel  │ │DocumentPerD│ │ApprovalHis  │
   │               │      │                │ │iem         │ │tory         │
   │ - id (PK)     │      │ - id (PK)      │ │            │ │             │
   │ - title       │      │ - date         │ │ - id (PK)  │ │ - id (PK)   │
   │ - document    │      │ - number_people│ │ - initial_ │ │ - level     │
   │   (FK)        │      │ - total        │ │   date     │ │ - approver  │
   │ - supplier    │      │ - route (FK)   │ │ - final_   │ │   (FK)      │
   │   (FK)        │      │ - comments     │ │   date     │ │ - document  │
   │ - tax (FK)    │      │ - document (FK)│ │ - total    │ │   (FK)      │
   │ - currency    │      │ - erased_at    │ │ - per_diem │ │ - is_approved
   │   (FK)        │      │ - created_at   │ │   (FK)     │ │ - operation_│
   │ - expense_    │      │ - updated_at   │ │ - document │ │   date      │
   │   concept(FK) │      └────────────────┘ │   (FK)     │ │ - comments  │
   │ - created_at  │                        │ - erased_at│ │             │
   │ - updated_at  │                        │ - created_│ │ (Generic FK)│
   │ - erased_at   │                        │   at       │ │             │
   └────┬──────────┘                        │ - updated_│ └─────────────┘
        │                                   │   at      │
        │ 1                                 │ - erased_ │
        │                                   │   at      │
        ▼ N                                 └───────────┘
   ┌──────────────────┐
   │  ExpenseFile     │   ┌────────────┐    ┌──────────┐   ┌──────────┐
   │                  │   │   Supplier │    │   Tax    │   │PerDiem   │
   │ - id (PK)        │   │            │    │          │   │          │
   │ - file           │   │ - id (PK)  │    │ - id(PK) │   │ - id(PK) │
   │ - document_      │   │ - name     │    │ - name   │   │ - name   │
   │   expense (FK)   │   │ - rut (UQ) │    │ - percentage│ │ - amount │
   │ - uploaded_at    │   │ - company  │    │ - company│   │ - company│
   └──────────────────┘   │   (FK)     │    │  (FK)    │   │  (FK)    │
                          └────────────┘    └──────────┘   └──────────┘

                      ┌────────────────┐   ┌──────────────┐
                      │ ExpenseConcept │   │ DocumentClass│
                      │                │   │              │
                      │ - id (PK)      │   │ - id (PK)    │
                      │ - name         │   │ - name       │
                      │ - description  │   │ - code       │
                      │ - company (FK) │   │ - document_  │
                      └────────────────┘   │   type       │
                                           │ - expense_   │
                      ┌────────────────┐   │   type       │
                      │   Location     │   │ - expense_   │
                      │                │   │   concept(FK)│
                      │ - id (PK)      │   │ - company(FK)│
                      │ - name         │   └──────────────┘
                      │ - description  │
                      └────────────────┘   ┌──────────────────┐
                             ▲            │AccountingAccount │
                             │ 2           │                  │
                      ┌──────┴────────┐    │ - id (PK)        │
                      │    Route      │    │ - name           │
                      │               │    │ - code           │
                      │ - id (PK)     │    │ - account        │
                      │ - name        │    │ - document_type  │
                      │ - distance_km │    │ - expense_concept│
                      │ - toll_cost   │    │ - company (FK)   │
                      │ - company(FK) │    └──────────────────┘
                      └────────────────┘

Legend:
  PK = Primary Key
  FK = Foreign Key
  UQ = Unique
  M2M = Many-to-Many
  1 = One
  N = Many
</code></pre></div></div>

<hr />

<h3 id="42-modelos-principales-descripción-uno-por-uno">4.2 Modelos Principales (Descripción Uno por Uno)</h3>

<h4 id="nivel-1-organización-y-usuarios"><strong>Nivel 1: Organización y Usuarios</strong></h4>

<h5 id="1-groups"><strong>1. Groups</strong></h5>

<p><strong>Propósito:</strong> Agrupar empresas y usuarios por clasificación organizacional.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=100): Nombre del grupo</li>
</ul>

<p><strong>Relaciones:</strong></p>

<ul>
  <li>Company (1:N) - Un grupo tiene muchas empresas</li>
  <li>User (M2M) - Un grupo tiene muchos usuarios</li>
</ul>

<p><strong>Ejemplo:</strong> <code class="language-plaintext highlighter-rouge">Grupo Constructora</code>, <code class="language-plaintext highlighter-rouge">Grupo Retail</code>, <code class="language-plaintext highlighter-rouge">Grupo Financiero</code></p>

<hr />

<h5 id="2-company"><strong>2. Company</strong></h5>

<p><strong>Propósito:</strong> Representa cada empresa/organización del sistema.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40, unique=True): Nombre de la empresa</li>
  <li><code class="language-plaintext highlighter-rouge">rut</code> (CharField, max_length=10, unique=True): Identificador fiscal (RUT, en el caso de Chile)</li>
  <li><code class="language-plaintext highlighter-rouge">address</code> (CharField, max_length=120): Dirección física</li>
  <li><code class="language-plaintext highlighter-rouge">email</code> (CharField, max_length=60): Email de contacto</li>
  <li><code class="language-plaintext highlighter-rouge">sap_code</code> (CharField, max_length=20): Código para integración SAP</li>
  <li><code class="language-plaintext highlighter-rouge">clvct</code> (CharField, max_length=10): Código cliente</li>
  <li><code class="language-plaintext highlighter-rouge">group</code> (FK → Groups): Grupo a que pertenece</li>
  <li><code class="language-plaintext highlighter-rouge">base_currency</code> (FK → Currency): Moneda base para conversiones</li>
  <li><code class="language-plaintext highlighter-rouge">currencies_allowed</code> (M2M → Currency): Monedas permitidas para gasto</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Relaciones:</strong></p>

<ul>
  <li>Groups (N:1) - FK con PROTECT</li>
  <li>Currency (N:1) - Base currency</li>
  <li>User (1:N) - Usuarios de la empresa</li>
  <li>CostCenter (1:N) - Centros de costo</li>
  <li>Area (1:N) - Áreas</li>
  <li>Supplier (1:N) - Proveedores</li>
  <li>Document (1:N) - Documentos</li>
  <li>Route (1:N) - Rutas</li>
  <li>Tax (1:N) - Impuestos</li>
  <li>ExpenseConcept (1:N) - Conceptos de gasto</li>
  <li>PerDiem (1:N) - Viáticos</li>
  <li>DocumentClass (1:N) - Clasificación de documentos</li>
  <li>AccountingAccount (1:N) - Cuentas contables</li>
</ul>

<p><strong>Validaciones:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code> debe ser único</li>
  <li><code class="language-plaintext highlighter-rouge">rut</code> debe ser único</li>
</ul>

<hr />

<h5 id="3-user-custom-auth-model"><strong>3. User (Custom Auth Model)</strong></h5>

<p><strong>Propósito:</strong> Usuarios del sistema con roles diferenciados.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li>Heredados de AbstractUser: <code class="language-plaintext highlighter-rouge">username</code>, <code class="language-plaintext highlighter-rouge">password</code>, <code class="language-plaintext highlighter-rouge">email</code>, <code class="language-plaintext highlighter-rouge">first_name</code>, <code class="language-plaintext highlighter-rouge">last_name</code>, <code class="language-plaintext highlighter-rouge">is_active</code>, <code class="language-plaintext highlighter-rouge">is_staff</code>, <code class="language-plaintext highlighter-rouge">is_superuser</code>, <code class="language-plaintext highlighter-rouge">date_joined</code>, <code class="language-plaintext highlighter-rouge">last_login</code></li>
  <li><code class="language-plaintext highlighter-rouge">role</code> (CharField, choices=[‘USER’, ‘APPROVER’, ‘ADMIN’]): Rol del usuario</li>
  <li><code class="language-plaintext highlighter-rouge">rut</code> (CharField, max_length=20, unique=True): Identificador fiscal</li>
  <li><code class="language-plaintext highlighter-rouge">phone</code> (CharField, max_length=20, nullable): Teléfono</li>
  <li><code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Relaciones:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa del usuario</li>
  <li><code class="language-plaintext highlighter-rouge">area</code> (FK → Area): Área del usuario</li>
  <li><code class="language-plaintext highlighter-rouge">group</code> (M2M → Groups): Grupos a los que pertenece</li>
</ul>

<p><strong>Validaciones:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean</span><span class="p">():</span>
    <span class="c1"># La empresa del usuario debe pertenece a alguno de sus grupos
</span>    <span class="k">if</span> <span class="n">company</span> <span class="ow">and</span> <span class="n">group</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">validate</span> <span class="n">company</span><span class="p">.</span><span class="n">group</span> <span class="ow">in</span> <span class="n">user</span><span class="p">.</span><span class="n">group</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>Roles:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">USER</code>: Usuario normal que crea documentos</li>
  <li><code class="language-plaintext highlighter-rouge">APPROVER</code>: Puede aprobar documentos según permisos</li>
  <li><code class="language-plaintext highlighter-rouge">ADMIN</code>: Acceso completo</li>
</ul>

<hr />

<h5 id="4-area"><strong>4. Area</strong></h5>

<p><strong>Propósito:</strong> Organizar usuarios por áreas dentro de una empresa.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40): Nombre del área</li>
  <li><code class="language-plaintext highlighter-rouge">code</code> (CharField, max_length=10, unique=True): Código único</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (CharField, max_length=40): Descripción</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Ejemplo:</strong> <code class="language-plaintext highlighter-rouge">IT</code>, <code class="language-plaintext highlighter-rouge">Recursos Humanos</code>, <code class="language-plaintext highlighter-rouge">Operaciones</code>, <code class="language-plaintext highlighter-rouge">Ventas</code></p>

<hr />

<h5 id="5-access"><strong>5. Access</strong></h5>

<p><strong>Propósito:</strong> Definir acceso de usuarios a centros de costo específicos.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">user</code> (FK → User): Usuario con acceso</li>
  <li><code class="language-plaintext highlighter-rouge">cost_center</code> (FK → CostCenter): Centro de costo autorizado</li>
  <li><code class="language-plaintext highlighter-rouge">comments</code> (TextField): Notas sobre el acceso</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Propósito:</strong> Control de acceso granular a centros de costo</p>

<hr />

<h4 id="nivel-2-permisos-y-aprobaciones"><strong>Nivel 2: Permisos y Aprobaciones</strong></h4>

<h5 id="6-userapprover"><strong>6. UserApprover</strong></h5>

<p><strong>Propósito:</strong> Define qué usuarios puede aprobar un aprobador.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">user</code> (FK → User): El aprobador</li>
  <li><code class="language-plaintext highlighter-rouge">can_approve_for</code> (M2M → User): Usuarios que puede aprobar</li>
</ul>

<p><strong>Flujo:</strong> Usuario A aprueba documentos de Usuarios B, C, D</p>

<hr />

<h5 id="7-costcenterapprover"><strong>7. CostCenterApprover</strong></h5>

<p><strong>Propósito:</strong> Define qué centros de costo puede aprobar un usuario.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">user</code> (FK → User): El aprobador</li>
  <li><code class="language-plaintext highlighter-rouge">cost_center</code> (M2M → CostCenter): Centros de costo que puede aprobar</li>
</ul>

<p><strong>Flujo:</strong> Usuario A aprueba documentos de los centros de costo X, Y, Z</p>

<hr />

<h5 id="8-companyapprover"><strong>8. CompanyApprover</strong></h5>

<p><strong>Propósito:</strong> Define qué empresas puede aprobar un usuario.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">user</code> (FK → User): El aprobador</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (M2M → Company): Empresas que puede aprobar</li>
</ul>

<p><strong>Flujo:</strong> Usuario A aprueba documentos de las empresas Empresa1, Empresa2</p>

<hr />

<h5 id="9-approvalhistory"><strong>9. ApprovalHistory</strong></h5>

<p><strong>Propósito:</strong> Auditoría completa de aprobaciones (4 niveles).</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">level</code> (IntegerField, choices=[1, 2, 3, 4]): Nivel de aprobación</li>
  <li><code class="language-plaintext highlighter-rouge">operation_date</code> (DateTimeField, auto_now_add): Fecha de operación</li>
  <li><code class="language-plaintext highlighter-rouge">is_approved</code> (BooleanField): True si aprobó, False si rechazó</li>
  <li><code class="language-plaintext highlighter-rouge">comments</code> (TextField, nullable): Comentarios del aprobador</li>
  <li><code class="language-plaintext highlighter-rouge">approver</code> (FK → User): Usuario que aprobó</li>
  <li><code class="language-plaintext highlighter-rouge">document</code> (FK → Document): Documento asociado</li>
  <li><code class="language-plaintext highlighter-rouge">content_type</code> (FK → ContentType): Tipo genérico de objeto</li>
  <li><code class="language-plaintext highlighter-rouge">object_id</code> (PositiveIntegerField): ID del objeto aprobado</li>
  <li><code class="language-plaintext highlighter-rouge">content_object</code> (Generic FK): Referencia al objeto (Expense, Travel, PerDiem)</li>
</ul>

<p><strong>Constraints:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UniqueConstraint</span><span class="p">(</span>
    <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'content_type'</span><span class="p">,</span> <span class="s">'object_id'</span><span class="p">,</span> <span class="s">'level'</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s">'uniq_approval_per_level_per_object'</span>
<span class="p">)</span>
<span class="c1"># Asegura que no puede haber 2 aprobaciones del mismo nivel para el mismo objeto
</span></code></pre></div></div>

<p><strong>Propósito:</strong> Permite polimorfismo - el mismo modelo maneja aprobaciones de DocumentExpense, DocumentTravel, DocumentPerDiem</p>

<hr />

<h4 id="nivel-3-operaciones---documentos-y-gastos"><strong>Nivel 3: Operaciones - Documentos y Gastos</strong></h4>

<h5 id="10-document"><strong>10. Document</strong></h5>

<p><strong>Propósito:</strong> Documento padre que agrupa gastos, viajes y viáticos.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">title</code> (CharField, max_length=40): Título del documento</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (TextField): Descripción detallada</li>
  <li><code class="language-plaintext highlighter-rouge">document_date</code> (DateTimeField): Fecha del documento</li>
  <li><code class="language-plaintext highlighter-rouge">state</code> (CharField, choices=[‘SAVED’, ‘PENDING’, ‘APPROVED’, ‘REJECTED’]): Estado</li>
  <li><code class="language-plaintext highlighter-rouge">recorded_subtotal</code> (DecimalField, 100,10): Subtotal en moneda original</li>
  <li><code class="language-plaintext highlighter-rouge">recorded_total</code> (DecimalField, 100,10): Total con impuestos en moneda original</li>
  <li><code class="language-plaintext highlighter-rouge">converted_subtotal</code> (DecimalField, 100,10): Subtotal convertido a base_currency</li>
  <li><code class="language-plaintext highlighter-rouge">converted_total</code> (DecimalField, 100,10): Total convertido a base_currency</li>
  <li><code class="language-plaintext highlighter-rouge">external_code</code> (TextField, nullable): Código de referencia en SAP</li>
  <li><code class="language-plaintext highlighter-rouge">paid</code> (BooleanField): Indica si fue pagado</li>
  <li><code class="language-plaintext highlighter-rouge">file</code> (FileField, nullable): PDF del documento (AWS S3)</li>
  <li><code class="language-plaintext highlighter-rouge">erased_at</code> (DateTimeField, nullable): Timestamp de borrado lógico</li>
  <li><code class="language-plaintext highlighter-rouge">enterprise</code> (FK → Company): Empresa del documento</li>
  <li><code class="language-plaintext highlighter-rouge">user</code> (FK → User): Usuario creador</li>
  <li><code class="language-plaintext highlighter-rouge">cost_center</code> (FK → CostCenter): Centro de costo</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Métodos:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">erase</span><span class="p">():</span>
    <span class="c1"># Soft delete - marca erased_at sin eliminar de DB
</span>    <span class="n">erased_at</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>
    <span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>Estados:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">SAVED</code>: Borrador, en edición</li>
  <li><code class="language-plaintext highlighter-rouge">PENDING</code>: Enviado para aprobación</li>
  <li><code class="language-plaintext highlighter-rouge">APPROVED</code>: Aprobado en todos los niveles</li>
  <li><code class="language-plaintext highlighter-rouge">REJECTED</code>: Rechazado</li>
</ul>

<hr />

<h5 id="11-documentexpense"><strong>11. DocumentExpense</strong></h5>

<p><strong>Propósito:</strong> Gasto individual dentro de un documento.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">title</code> (CharField, max_length=40): Descripción del gasto</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (TextField): Detalle adicional</li>
  <li><code class="language-plaintext highlighter-rouge">document_number</code> (CharField, max_length=40): Número de factura/recibo</li>
  <li><code class="language-plaintext highlighter-rouge">expense_date</code> (DateTimeField): Fecha del gasto</li>
  <li><code class="language-plaintext highlighter-rouge">expense_type</code> (CharField, choices=[‘RECIBO’, ‘FACTURA_EXCENTA’, ‘FACTURA_ELECTRONICA’, ‘BOLETA_ELECTRONICA’, ‘BOLETA’]): Tipo de comprobante</li>
  <li><code class="language-plaintext highlighter-rouge">recorded_subtotal</code> (DecimalField, 100,10): Subtotal sin impuesto</li>
  <li><code class="language-plaintext highlighter-rouge">converted_subtotal</code> (DecimalField, 100,10): Subtotal convertido</li>
  <li><code class="language-plaintext highlighter-rouge">recorded_total</code> (DecimalField, 100,10): Total con impuesto</li>
  <li><code class="language-plaintext highlighter-rouge">converted_total</code> (DecimalField, 100,10): Total convertido</li>
  <li><code class="language-plaintext highlighter-rouge">external_code</code> (CharField, max_length=40, nullable): Código SAP</li>
  <li><code class="language-plaintext highlighter-rouge">document</code> (FK → Document): Documento padre</li>
  <li><code class="language-plaintext highlighter-rouge">supplier</code> (FK → Supplier, nullable): Proveedor</li>
  <li><code class="language-plaintext highlighter-rouge">expense_concept</code> (FK → ExpenseConcept): Concepto del gasto</li>
  <li><code class="language-plaintext highlighter-rouge">currency</code> (FK → Currency): Moneda original</li>
  <li><code class="language-plaintext highlighter-rouge">tax</code> (FK → Tax): Impuesto aplicado</li>
  <li><code class="language-plaintext highlighter-rouge">erased_at</code> (DateTimeField, nullable): Soft delete</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Métodos Especiales:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Al crear: actualiza totales del documento
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
    <span class="c1"># Al actualizar: solo si no está marcado como eliminado
</span>    <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">erased_at</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">erase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Soft delete
</span>    <span class="n">erased_at</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>
    <span class="n">save</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">update_document_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Agrega montos al documento padre
</span>    <span class="n">document</span><span class="p">.</span><span class="n">converted_subtotal</span> <span class="o">+=</span> <span class="n">converted_subtotal</span>
    <span class="n">document</span><span class="p">.</span><span class="n">converted_total</span> <span class="o">+=</span> <span class="n">converted_total</span>
    <span class="n">document</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>Regla de Negocio:</strong> Al crear/actualizar, recalcula totales del documento padre</p>

<hr />

<h5 id="12-expensefile"><strong>12. ExpenseFile</strong></h5>

<p><strong>Propósito:</strong> Adjuntos (imágenes, PDFs) para un gasto.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">file</code> (FileField, upload_to=’expense_files/’): Archivo en AWS S3</li>
  <li><code class="language-plaintext highlighter-rouge">document_expense</code> (FK → DocumentExpense): Gasto asociado</li>
  <li><code class="language-plaintext highlighter-rouge">uploaded_at</code> (DateTimeField, auto_now_add)</li>
</ul>

<p><strong>Propósito:</strong> Evidencia de gastos (fotos de recibos, PDFs)</p>

<hr />

<h5 id="13-documenttravel"><strong>13. DocumentTravel</strong></h5>

<p><strong>Propósito:</strong> Gasto por viaje dentro de un documento.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">date</code> (DateTimeField): Fecha del viaje</li>
  <li><code class="language-plaintext highlighter-rouge">number_people</code> (IntegerField): Cantidad de personas</li>
  <li><code class="language-plaintext highlighter-rouge">reason</code> (TextField): Motivo del viaje</li>
  <li><code class="language-plaintext highlighter-rouge">total</code> (DecimalField, 100,10): Costo total del viaje</li>
  <li><code class="language-plaintext highlighter-rouge">external_code</code> (CharField, max_length=40, nullable): Código SAP</li>
  <li><code class="language-plaintext highlighter-rouge">comments</code> (TextField): Comentarios</li>
  <li><code class="language-plaintext highlighter-rouge">route</code> (FK → Route): Ruta del viaje</li>
  <li><code class="language-plaintext highlighter-rouge">document</code> (FK → Document): Documento padre</li>
  <li><code class="language-plaintext highlighter-rouge">erased_at</code> (DateTimeField, nullable): Soft delete</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Métodos:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Similar a DocumentExpense - actualiza documento padre
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">erased_at</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h5 id="14-documentperdiem"><strong>14. DocumentPerDiem</strong></h5>

<p><strong>Propósito:</strong> Gasto por viático (gastos diarios) dentro de un documento.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">initial_date</code> (DateTimeField): Fecha inicial del viático</li>
  <li><code class="language-plaintext highlighter-rouge">final_date</code> (DateTimeField): Fecha final del viático</li>
  <li><code class="language-plaintext highlighter-rouge">total</code> (DecimalField, 100,10): Monto total del viático</li>
  <li><code class="language-plaintext highlighter-rouge">external_code</code> (CharField, max_length=40, nullable): Código SAP</li>
  <li><code class="language-plaintext highlighter-rouge">reason</code> (TextField): Motivo del viático</li>
  <li><code class="language-plaintext highlighter-rouge">per_diem</code> (FK → PerDiem): Configuración de viático</li>
  <li><code class="language-plaintext highlighter-rouge">document</code> (FK → Document): Documento padre</li>
  <li><code class="language-plaintext highlighter-rouge">erased_at</code> (DateTimeField, nullable): Soft delete</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Métodos:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Similar a DocumentExpense - actualiza documento padre
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">erased_at</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h4 id="nivel-4-configuración-y-maestros"><strong>Nivel 4: Configuración y Maestros</strong></h4>

<h5 id="15-supplier"><strong>15. Supplier</strong></h5>

<p><strong>Propósito:</strong> Proveedores/acreedores del sistema.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40): Nombre del proveedor</li>
  <li><code class="language-plaintext highlighter-rouge">rut</code> (CharField, max_length=10, unique=True): RUT del proveedor</li>
  <li><code class="language-plaintext highlighter-rouge">address</code> (CharField, max_length=40): Dirección</li>
  <li><code class="language-plaintext highlighter-rouge">email</code> (CharField, max_length=20): Email</li>
  <li><code class="language-plaintext highlighter-rouge">phone</code> (CharField, max_length=20): Teléfono</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<hr />

<h5 id="16-costcenter"><strong>16. CostCenter</strong></h5>

<p><strong>Propósito:</strong> Centros de costo para clasificar gastos.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40, unique=True): Nombre único</li>
  <li><code class="language-plaintext highlighter-rouge">code</code> (CharField, max_length=10, unique=True): Código único</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (CharField, max_length=40): Descripción</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Ejemplo:</strong> <code class="language-plaintext highlighter-rouge">CECO-001</code>, <code class="language-plaintext highlighter-rouge">CECO-002</code>, <code class="language-plaintext highlighter-rouge">ADMIN</code>, <code class="language-plaintext highlighter-rouge">VENTAS</code></p>

<hr />

<h5 id="17-tax"><strong>17. Tax</strong></h5>

<p><strong>Propósito:</strong> Impuestos aplicables a gastos.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40): Nombre (ej: “IVA”)</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (TextField): Descripción</li>
  <li><code class="language-plaintext highlighter-rouge">percentage</code> (DecimalField, 5,2): Porcentaje del impuesto</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Ejemplo:</strong> IVA 19%, IVA Reducido 4%, Sin impuesto 0%</p>

<hr />

<h5 id="18-expenseconcept"><strong>18. ExpenseConcept</strong></h5>

<p><strong>Propósito:</strong> Clasificación de conceptos de gasto, también identificado como categoría.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40): Nombre del concepto</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (TextField): Descripción</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Ejemplo:</strong> <code class="language-plaintext highlighter-rouge">Alimentación</code>, <code class="language-plaintext highlighter-rouge">Transporte</code>, <code class="language-plaintext highlighter-rouge">Hospedaje</code>, <code class="language-plaintext highlighter-rouge">Servicios Profesionales</code></p>

<hr />

<h5 id="19-perdiem"><strong>19. PerDiem</strong></h5>

<p><strong>Propósito:</strong> Configuración de montos de viáticos por día.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40): Nombre del tipo de viático</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (TextField): Descripción</li>
  <li><code class="language-plaintext highlighter-rouge">amount</code> (DecimalField, 100,10): Monto diario</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Ejemplo:</strong></p>

<ul>
  <li>Viático Nacional: $50.000/día</li>
  <li>Viático Internacional: $100.000/día</li>
</ul>

<hr />

<h5 id="20-route"><strong>20. Route</strong></h5>

<p><strong>Propósito:</strong> Rutas de viaje preconfiguradas.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40): Nombre de la ruta</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (TextField): Descripción</li>
  <li><code class="language-plaintext highlighter-rouge">distance_km</code> (DecimalField, 100,10): Distancia en km</li>
  <li><code class="language-plaintext highlighter-rouge">toll_cost</code> (DecimalField, 100,10): Costo de peajes</li>
  <li><code class="language-plaintext highlighter-rouge">origin</code> (FK → Location, nullable): Ubicación origen</li>
  <li><code class="language-plaintext highlighter-rouge">destination</code> (FK → Location, nullable): Ubicación destino</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Validaciones:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean</span><span class="p">():</span>
    <span class="c1"># Origin y destination deben ser diferentes
</span>    <span class="n">validate</span> <span class="n">origin</span> <span class="o">!=</span> <span class="n">destination</span>

<span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="c1"># Distance no puede ser negativa
</span>    <span class="n">validate</span> <span class="n">distance_km</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</code></pre></div></div>

<hr />

<h5 id="21-location"><strong>21. Location</strong></h5>

<p><strong>Propósito:</strong> Ubicaciones geográficas para rutas (a mejorar con integración a una API geográfica).</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=40): Nombre de la ubicación</li>
  <li><code class="language-plaintext highlighter-rouge">description</code> (TextField): Descripción</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Ejemplo:</strong> <code class="language-plaintext highlighter-rouge">Santiago</code>, <code class="language-plaintext highlighter-rouge">Valparaíso</code>, <code class="language-plaintext highlighter-rouge">Concepción</code>, <code class="language-plaintext highlighter-rouge">Oficina Centro</code></p>

<hr />

<h5 id="22-currency"><strong>22. Currency</strong></h5>

<p><strong>Propósito:</strong> Monedas disponibles en el sistema.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=50): Código o nombre (ej: “USD”, “CLP”, “EUR”)</li>
  <li><code class="language-plaintext highlighter-rouge">comments</code> (TextField, nullable): Notas</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Meta:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">verbose_name</span> <span class="o">=</span> <span class="s">'Currency'</span>
<span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s">'Currencies'</span>
<span class="n">db_table</span> <span class="o">=</span> <span class="s">'currency'</span>
</code></pre></div></div>

<hr />

<h4 id="nivel-5-integración-con-sistemas-externos"><strong>Nivel 5: Integración con Sistemas Externos</strong></h4>

<h5 id="23-documentclass"><strong>23. DocumentClass</strong></h5>

<p><strong>Propósito:</strong> Mapeo de tipos de documento para integración SAP.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=50): Nombre descriptivo</li>
  <li><code class="language-plaintext highlighter-rouge">code</code> (CharField, max_length=50): Código en SAP</li>
  <li><code class="language-plaintext highlighter-rouge">document_type</code> (CharField, choices=[‘EXPENSE’, ‘TRAVEL’, ‘PER_DIEM’]): Tipo de documento</li>
  <li><code class="language-plaintext highlighter-rouge">expense_type</code> (CharField, choices=[…], nullable): Para EXPENSE, tipo de comprobante</li>
  <li><code class="language-plaintext highlighter-rouge">expense_concept</code> (FK → ExpenseConcept, nullable): Para EXPENSE, concepto</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">comments</code> (TextField): Notas</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Validaciones:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">document_type</span> <span class="o">==</span> <span class="s">'EXPENSE'</span><span class="p">:</span>
        <span class="c1"># Debe tener expense_type y expense_concept
</span>        <span class="n">validate</span> <span class="n">expense_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">validate</span> <span class="n">expense_concept</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">document_type</span> <span class="o">==</span> <span class="s">'TRAVEL'</span><span class="p">:</span>
        <span class="c1"># No debe tener expense_type ni expense_concept
</span>        <span class="n">validate</span> <span class="n">expense_type</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="n">validate</span> <span class="n">expense_concept</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">document_type</span> <span class="o">==</span> <span class="s">'PER_DIEM'</span><span class="p">:</span>
        <span class="c1"># No debe tener expense_type ni expense_concept
</span>        <span class="n">validate</span> <span class="n">expense_type</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="n">validate</span> <span class="n">expense_concept</span> <span class="ow">is</span> <span class="bp">None</span>
</code></pre></div></div>

<hr />

<h5 id="24-accountingaccount"><strong>24. AccountingAccount</strong></h5>

<p><strong>Propósito:</strong> Mapeo de cuentas contables para integración SAP.</p>

<p><strong>Campos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code> (PK): Identificador único</li>
  <li><code class="language-plaintext highlighter-rouge">name</code> (CharField, max_length=50): Nombre de la cuenta</li>
  <li><code class="language-plaintext highlighter-rouge">code</code> (CharField, max_length=50): Código contable</li>
  <li><code class="language-plaintext highlighter-rouge">account</code> (CharField, max_length=50): Número de cuenta en SAP</li>
  <li><code class="language-plaintext highlighter-rouge">document_type</code> (CharField, choices=[‘EXPENSE’, ‘TRAVEL’, ‘PER_DIEM’]): Tipo de documento</li>
  <li><code class="language-plaintext highlighter-rouge">expense_concept</code> (FK → ExpenseConcept, nullable): Para EXPENSE</li>
  <li><code class="language-plaintext highlighter-rouge">company</code> (FK → Company): Empresa propietaria</li>
  <li><code class="language-plaintext highlighter-rouge">comments</code> (TextField): Notas</li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">updated_at</code> (DateTimeField)</li>
</ul>

<p><strong>Validaciones:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">document_type</span> <span class="o">==</span> <span class="s">'EXPENSE'</span><span class="p">:</span>
        <span class="n">validate</span> <span class="n">expense_concept</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">document_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'TRAVEL'</span><span class="p">,</span> <span class="s">'PER_DIEM'</span><span class="p">]:</span>
        <span class="n">validate</span> <span class="n">expense_concept</span> <span class="ow">is</span> <span class="bp">None</span>
</code></pre></div></div>

<hr />

<h3 id="43-campos-importantes-y-relaciones">4.3 Campos Importantes y Relaciones</h3>

<h4 id="campos-críticos-con-on_deletemodelsprotect"><strong>Campos Críticos con on_delete=models.PROTECT</strong></h4>

<p>Previenen eliminación de registros relacionados:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Company
├── Groups (PROTECT)        # No puede eliminar grupo si tiene empresas
├── Currency (PROTECT)      # No puede eliminar moneda base si está en uso
└── User.company (PROTECT)  # No puede eliminar empresa si tiene usuarios

User
├── Company (PROTECT)       # No puede eliminar si tiene usuarios
└── Area (PROTECT)          # No puede eliminar área si tiene usuarios

Document
├── Enterprise/Company (PROTECT) # No puede eliminar empresa
├── User (PROTECT)               # No puede eliminar usuario
└── CostCenter (PROTECT)         # No puede eliminar centro costo

DocumentExpense
├── Document (PROTECT)      # No puede eliminar documento si tiene gastos
├── Supplier (PROTECT)      # No puede eliminar proveedor
├── ExpenseConcept (PROTECT)# No puede eliminar concepto
├── Currency (PROTECT)      # No puede eliminar moneda
└── Tax (PROTECT)           # No puede eliminar impuesto
</code></pre></div></div>

<hr />

<h4 id="campos-con-on_deletemodelscascade"><strong>Campos con on_delete=models.CASCADE</strong></h4>

<p>Eliminan registros dependientes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ExpenseFile
└── DocumentExpense (CASCADE) # Elimina archivos si se elimina gasto
</code></pre></div></div>

<hr />

<h4 id="soft-delete-borrado-lógico"><strong>Soft Delete (Borrado Lógico)</strong></h4>

<p>Modelos con campo <code class="language-plaintext highlighter-rouge">erased_at</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Document
├── erase()  # Marca erased_at = now()
└── Consultas deben filtrar donde erased_at IS NULL

DocumentExpense
├── erase()  # Marca erased_at = now()
└── update_document_total() se salta si erased_at not null

DocumentTravel
├── erase()
└── Similar a DocumentExpense

DocumentPerDiem
├── erase()
└── Similar a DocumentExpense
</code></pre></div></div>

<hr />

<h3 id="44-reglas-de-negocio-dentro-de-modelos">4.4 Reglas de Negocio Dentro de Modelos</h3>

<h4 id="autoincremento-de-totales"><strong>Autoincremento de Totales</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># DocumentExpense.save()
</span><span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">pk</span><span class="p">:</span>  <span class="c1"># Creación
</span>    <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
    <span class="c1"># Agrega montos al documento padre
</span>
<span class="c1"># DocumentTravel.save()
</span><span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">pk</span><span class="p">:</span>  <span class="c1"># Creación
</span>    <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
    <span class="c1"># Agrega montos al documento padre
</span>
<span class="c1"># DocumentPerDiem.save()
</span><span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">pk</span><span class="p">:</span>  <span class="c1"># Creación
</span>    <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">update_document_total</span><span class="p">()</span>
    <span class="c1"># Agrega montos al documento padre
</span></code></pre></div></div>

<p><strong>Efecto:</strong> Document.converted_total se actualiza automáticamente</p>

<hr />

<h4 id="validación-de-rutas"><strong>Validación de Rutas</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Route.clean()
</span><span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="n">destination</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">'Origin and destination must be different'</span><span class="p">)</span>

<span class="c1"># Route.save()
</span><span class="k">if</span> <span class="n">distance_km</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">'Distance cannot be negative'</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h4 id="validación-de-usuario-y-compañía"><strong>Validación de Usuario y Compañía</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># User.clean()
</span><span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">company</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">group</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">group</span><span class="p">.</span><span class="nb">all</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">'La compañía seleccionada no pertenece a los grupos del usuario'</span>
        <span class="p">)</span>
</code></pre></div></div>

<p><strong>Propósito:</strong> Asegurar que la empresa del usuario pertenece a uno de sus grupos</p>

<hr />

<h4 id="unicidad-compuesta-en-approvalhistory"><strong>Unicidad Compuesta en ApprovalHistory</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Meta constraint
</span><span class="n">UniqueConstraint</span><span class="p">(</span>
    <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'content_type'</span><span class="p">,</span> <span class="s">'object_id'</span><span class="p">,</span> <span class="s">'level'</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s">'uniq_approval_per_level_per_object'</span>
<span class="p">)</span>
</code></pre></div></div>

<p><strong>Propósito:</strong> Evitar aprobaciones duplicadas del mismo nivel para el mismo objeto</p>

<hr />

<h3 id="45-migraciones-estructura-y-comandos">4.5 Migraciones (Estructura y Comandos)</h3>

<h4 id="archivos-de-migraciones"><strong>Archivos de Migraciones</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app/migrations/
├── __init__.py
├── 0001_initial.py           # Creación inicial de modelos
├── 0002_groups_rename_...py  # Rename y ajustes
├── 0003_currency.py          # Agregar Currency
├── 0004_insert_currencys.py  # Data insertion
├── 0005_company_currencies_allowed.py
├── 0006_company_base_currency.py
├── 0007_documentexpense_currency.py
├── 0008_alter_company_address_...py
├── 0009_document_file.py
├── 0010_location_route_...py
├── 0011_document_paid_...py
├── 0012_approvalhistory_content_type_and_more.py
└── __pycache__/
</code></pre></div></div>

<hr />

<h4 id="comandos-django-para-migraciones"><strong>Comandos Django para Migraciones</strong></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Crear migración automática</span>
python manage.py makemigrations

<span class="c"># Aplicar migraciones</span>
python manage.py migrate

<span class="c"># Ver estado de migraciones</span>
python manage.py showmigrations

<span class="c"># Deshacer última migración</span>
python manage.py migrate app 0011

<span class="c"># Ver SQL de una migración</span>
python manage.py sqlmigrate app 0012

<span class="c"># Ver cambios sin aplicar</span>
python manage.py makemigrations <span class="nt">--dry-run</span> <span class="nt">--verbosity</span> 3
</code></pre></div></div>

<hr />

<h4 id="proceso-de-migración-en-producción"><strong>Proceso de Migración en Producción</strong></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1. Crear cambios en models.py</span>
<span class="c"># 2. Crear migración</span>
python manage.py makemigrations

<span class="c"># 3. Validar migración</span>
python manage.py sqlmigrate app &lt;numero&gt;

<span class="c"># 4. Revisar cambios en git antes de deploy</span>

<span class="c"># 5. En producción</span>
python manage.py migrate <span class="nt">--no-input</span>

<span class="c"># 6. Verificar</span>
python manage.py showmigrations
</code></pre></div></div>

<hr />

<h2 id="resumen-de-base-de-datos">Resumen de Base de Datos</h2>

<table>
  <thead>
    <tr>
      <th>Aspecto</th>
      <th>Detalles</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Total de Modelos</strong></td>
      <td>24 modelos</td>
    </tr>
    <tr>
      <td><strong>Nivel 1 (Org)</strong></td>
      <td>5 modelos (Groups, Company, User, Area, Access)</td>
    </tr>
    <tr>
      <td><strong>Nivel 2 (Permisos)</strong></td>
      <td>4 modelos (UserApprover, CostCenterApprover, CompanyApprover, ApprovalHistory)</td>
    </tr>
    <tr>
      <td><strong>Nivel 3 (Ops)</strong></td>
      <td>5 modelos (Document, DocumentExpense, DocumentTravel, DocumentPerDiem, ExpenseFile)</td>
    </tr>
    <tr>
      <td><strong>Nivel 4 (Config)</strong></td>
      <td>6 modelos (Supplier, CostCenter, Tax, ExpenseConcept, PerDiem, Route, Location, Currency)</td>
    </tr>
    <tr>
      <td><strong>Nivel 5 (ERP)</strong></td>
      <td>2 modelos (DocumentClass, AccountingAccount)</td>
    </tr>
    <tr>
      <td><strong>Borrado Lógico</strong></td>
      <td>Document, DocumentExpense, DocumentTravel, DocumentPerDiem</td>
    </tr>
    <tr>
      <td><strong>Soft Protect</strong></td>
      <td>25+ relaciones con on_delete=PROTECT</td>
    </tr>
    <tr>
      <td><strong>Generic Relations</strong></td>
      <td>ApprovalHistory → DocumentExpense/Travel/PerDiem</td>
    </tr>
    <tr>
      <td><strong>Many-to-Many</strong></td>
      <td>8 relaciones M2M (Groups, Permisos, Currencies)</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="5-api-y-endpoints">5. API y Endpoints</h2>

<h3 id="51-convenciones-de-rutas-rest-versión-prefijos">5.1 Convenciones de Rutas (REST, Versión, Prefijos)</h3>

<h4 id="estructura-general-de-urls"><strong>Estructura General de URLs</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://api.rinderline.com/api/v1/app/{feature}/{resource}/{action}
│                                │  │   │         │         │
│                                │  │   │         │         └─ Acciones custom (POST)
│                                │  │   │         └─ Recurso (plural)
│                                │  │   └─ Feature/dominio
│                                │  └─ Prefijo app
│                                └─ Versionado
</code></pre></div></div>

<h4 id="patrones-de-url"><strong>Patrones de URL</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET    /api/v1/app/documents/                    # Listar documentos
POST   /api/v1/app/documents/                    # Crear documento

GET    /api/v1/app/documents/&lt;id&gt;/               # Detalle de documento
PUT    /api/v1/app/documents/&lt;id&gt;/               # Actualizar completo
PATCH  /api/v1/app/documents/&lt;id&gt;/               # Actualizar parcial
DELETE /api/v1/app/documents/&lt;id&gt;/               # Eliminar

GET    /api/v1/app/documents/?state=PENDING      # Filtrar por query param
GET    /api/v1/app/documents/?page=2&amp;limit=15    # Paginación

POST   /api/v1/app/documents/&lt;id&gt;/items/         # Sub-recurso
GET    /api/v1/app/approvals/pending/            # Listado filtrado
POST   /api/v1/app/auth/login/                   # Acción custom
</code></pre></div></div>

<h4 id="prefijos-y-namespaces"><strong>Prefijos y Namespaces</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/api/v1/          # Versionado explícito para backward compatibility
/api/v1/app/      # Aplicación principal (no admin)
/api/v1/app/auth/        # AuthViewSet
/api/v1/app/documents/   # Web feature - Documentos
/api/v1/app/approvals/   # Web feature - Aprobaciones
/api/v1/app/dashboards/  # Web feature - Dashboards
/api/v1/app/info/        # Web feature - Información
/api/v1/app/reports/     # Web feature - Reportes
/api/v1/app/sap/         # Web feature - SAP
/api/v1/app/admin/       # Admin feature - Administración
</code></pre></div></div>

<hr />

<h3 id="52-autenticación-y-autorización">5.2 Autenticación y Autorización</h3>

<h4 id="token-authentication"><strong>Token Authentication</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Flujo:
1. Cliente hace POST /api/v1/app/auth/login/
   Body: {"username": "juan", "password": "pass123"}

2. Backend valida credenciales y genera Token
   Response: {"token": "abc123def456xyz789"}

3. Cliente almacena token en localStorage

4. Cliente incluye en headers de siguientes requests:
   Authorization: Token abc123def456xyz789
   (o alternativo: Authorization: Bearer abc123def456xyz789)

5. Backend valida token y asigna user a request.user
</code></pre></div></div>

<h4 id="clases-de-autenticación"><strong>Clases de Autenticación</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">TokenAuthentication</span><span class="p">,</span>      <span class="c1"># Authorization: Token &lt;key&gt;
</span>    <span class="n">BasicAuthentication</span>       <span class="c1"># Authorization: Basic &lt;base64(user:pass)&gt;
</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="clases-de-permisos"><strong>Clases de Permisos</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">permissions</span><span class="p">.</span><span class="n">IsAuthenticated</span><span class="p">,</span>  <span class="c1"># Usuario debe estar autenticado
</span>    <span class="n">permissions</span><span class="p">.</span><span class="n">IsAdminUser</span><span class="p">,</span>      <span class="c1"># Usuario debe ser staff/admin
</span>    <span class="n">custom</span><span class="p">.</span><span class="n">IsApprover</span><span class="p">,</span>            <span class="c1"># Usuario tiene rol APPROVER
</span>    <span class="n">custom</span><span class="p">.</span><span class="n">IsEmployeeApprover</span><span class="p">,</span>    <span class="c1"># Usuario puede aprobar por usuarios
</span>    <span class="n">custom</span><span class="p">.</span><span class="n">IsCostCenterApprover</span><span class="p">,</span>  <span class="c1"># Usuario puede aprobar por ceco
</span>    <span class="n">custom</span><span class="p">.</span><span class="n">IsCompanyApprover</span>      <span class="c1"># Usuario puede aprobar por empresa
</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="validación-de-permisos-en-tiempo-de-ejecución"><strong>Validación de Permisos en Tiempo de Ejecución</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># En views.py
</span><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c1"># Validar permisos granulares
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span><span class="p">(</span><span class="s">"User not authenticated"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'APPROVER'</span><span class="p">,</span> <span class="s">'ADMIN'</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span><span class="p">(</span><span class="s">"User is not an approver"</span><span class="p">)</span>

    <span class="c1"># Validar acceso a documento específico
</span>    <span class="n">document</span> <span class="o">=</span> <span class="n">Document</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">document</span><span class="p">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">request</span><span class="p">.</span><span class="n">user</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_approver_for</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span><span class="p">(</span><span class="s">"No access to this document"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h3 id="53-endpoints-principales-getpostputpatchdelete">5.3 Endpoints Principales (GET/POST/PUT/PATCH/DELETE)</h3>

<h4 id="autenticación---apiv1appauth"><strong>AUTENTICACIÓN - /api/v1/app/auth/</strong></h4>

<table>
  <thead>
    <tr>
      <th>Método</th>
      <th>Endpoint</th>
      <th>Descripción</th>
      <th>Autenticación</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>POST</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/auth/register/</code></td>
      <td>Registrar nuevo usuario</td>
      <td>Ninguna</td>
    </tr>
    <tr>
      <td><strong>POST</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/auth/login/</code></td>
      <td>Login y obtener token</td>
      <td>Ninguna</td>
    </tr>
    <tr>
      <td><strong>POST</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/auth/logout/</code></td>
      <td>Logout (elimina token)</td>
      <td>Token requerido</td>
    </tr>
  </tbody>
</table>

<p><strong>Ejemplo POST /auth/login/</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/api/v1/app/auth/login/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"juan.perez"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Segura123!"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Response 200 OK</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="documentos---apiv1appdocuments"><strong>DOCUMENTOS - /api/v1/app/documents/</strong></h4>

<table>
  <thead>
    <tr>
      <th>Método</th>
      <th>Endpoint</th>
      <th>Descripción</th>
      <th>Headers</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/</code></td>
      <td>Listar documentos del usuario</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/?state=PENDING</code></td>
      <td>Filtrar por estado</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/drafts/</code></td>
      <td>Listar solo SAVED</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>POST</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/</code></td>
      <td>Crear documento</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/&lt;id&gt;/</code></td>
      <td>Detalle de documento</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/&lt;id&gt;/items/</code></td>
      <td>Items del documento</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>PUT</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/&lt;id&gt;/</code></td>
      <td>Actualizar documento</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>DELETE</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/&lt;id&gt;/delete/</code></td>
      <td>Soft delete de documento</td>
      <td>Token</td>
    </tr>
  </tbody>
</table>

<p><strong>Ejemplo GET /documents/</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/api/v1/app/documents/?state=PENDING&amp;page=1</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</span>
</code></pre></div></div>

<p><strong>Response 200 OK</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Viaje a Santiago"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Viaje de negocios Q4"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PENDING"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"enterprise"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Empresa ABC"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"juan.perez"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"cost_center"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CECO-001"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"recorded_total"</span><span class="p">:</span><span class="w"> </span><span class="mf">1500000.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"converted_total"</span><span class="p">:</span><span class="w"> </span><span class="mf">1500000.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"paid"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-11-30T10:30:00Z"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"pagination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
    </span><span class="nl">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"?page=2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"previous"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nl">"page_size"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Ejemplo POST /documents/</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/api/v1/app/documents/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">multipart/form-data</span>

document[title]=Gasto Hotel&amp;
document[description]=Hotel Sheraton&amp;
expenses[0][title]=Hospedaje 1 noche&amp;
expenses[0][amount]=250000&amp;
expenses[0][tax_id]=1&amp;
expenses[0][currency_id]=1&amp;
expenses[0][expense_concept_id]=3
</code></pre></div></div>

<hr />

<h4 id="aprobaciones---apiv1appapprovals"><strong>APROBACIONES - /api/v1/app/approvals/</strong></h4>

<table>
  <thead>
    <tr>
      <th>Método</th>
      <th>Endpoint</th>
      <th>Descripción</th>
      <th>Requiere</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/approvals/pending/</code></td>
      <td>Documentos pendientes</td>
      <td>IsApprover</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/approvals/history/</code></td>
      <td>Historial de aprobaciones</td>
      <td>IsApprover</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/approvals/documents/&lt;id&gt;/</code></td>
      <td>Detalle para aprobar</td>
      <td>IsApprover</td>
    </tr>
    <tr>
      <td><strong>PATCH</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/approvals/expenses/&lt;id&gt;/</code></td>
      <td>Aprobar/Rechazar gasto</td>
      <td>IsApprover</td>
    </tr>
    <tr>
      <td><strong>PATCH</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/approvals/travels/&lt;id&gt;/</code></td>
      <td>Aprobar/Rechazar viaje</td>
      <td>IsApprover</td>
    </tr>
    <tr>
      <td><strong>PATCH</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/approvals/per-diems/&lt;id&gt;/</code></td>
      <td>Aprobar/Rechazar viático</td>
      <td>IsApprover</td>
    </tr>
  </tbody>
</table>

<p><strong>Ejemplo GET /approvals/pending/</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/api/v1/app/approvals/pending/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</span>
</code></pre></div></div>

<p><strong>Response 200 OK</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Viaje a Santiago"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"juan.perez"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"cost_center"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CECO-001"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PENDING"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expense"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hotel"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="mi">250000</span><span class="p">,</span><span class="w">
          </span><span class="nl">"pending_approval"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"travel"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pasaje aéreo"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="mi">450000</span><span class="p">,</span><span class="w">
          </span><span class="nl">"pending_approval"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>**Ejemplo PATCH /approvals/expenses/<id>/**</id></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/api/v1/app/approvals/expenses/1/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"is_approved"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Aprobado. Monto acorde a política."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Response 200 OK</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Expense approved at level 1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="dashboards---apiv1appdashboards"><strong>DASHBOARDS - /api/v1/app/dashboards/</strong></h4>

<table>
  <thead>
    <tr>
      <th>Método</th>
      <th>Endpoint</th>
      <th>Descripción</th>
      <th>Requiere</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/dashboards/employee/</code></td>
      <td>Dashboard empleado</td>
      <td>IsAuthenticated</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/dashboards/approvers/user/</code></td>
      <td>Dashboard aprobador por usuario</td>
      <td>IsEmployeeApprover</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/dashboards/approvers/cost-center/</code></td>
      <td>Dashboard aprobador por ceco</td>
      <td>IsCostCenterApprover</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/dashboards/approvers/company/</code></td>
      <td>Dashboard aprobador por empresa</td>
      <td>IsCompanyApprover</td>
    </tr>
  </tbody>
</table>

<p><strong>Ejemplo GET /dashboards/employee/</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/api/v1/app/dashboards/employee/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</span>
</code></pre></div></div>

<p><strong>Response 200 OK</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"barChartData"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"months"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Ene"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Feb"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mar"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"values"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">150000</span><span class="p">,</span><span class="w"> </span><span class="mi">250000</span><span class="p">,</span><span class="w"> </span><span class="mi">180000</span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"pieChartData"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Gastos"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Viajes"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Viáticos"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"values"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"stats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"total_expenses"</span><span class="p">:</span><span class="w"> </span><span class="mf">1500000.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pending_approval"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"approved"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nl">"rejected"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="información---apiv1appinfo"><strong>INFORMACIÓN - /api/v1/app/info/</strong></h4>

<table>
  <thead>
    <tr>
      <th>Método</th>
      <th>Endpoint</th>
      <th>Descripción</th>
      <th>Autenticación</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/test/</code></td>
      <td>Test del API</td>
      <td>Ninguna</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/users/me/</code></td>
      <td>Perfil del usuario actual</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>PUT</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/users/me/profile/</code></td>
      <td>Actualizar perfil</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>POST</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/suppliers/</code></td>
      <td>Crear proveedor</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/information/</code></td>
      <td>Información accesible al usuario</td>
      <td>Token</td>
    </tr>
  </tbody>
</table>

<p><strong>Ejemplo GET /users/me/</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/api/v1/app/users/me/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</span>
</code></pre></div></div>

<p><strong>Response 200 OK</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"juan.perez"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"juan@company.com"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"first_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Juan"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"last_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pérez"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"+56912345678"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rut"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12.345.678-9"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"company"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Empresa ABC"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"USER"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_active"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_user_approver"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_cost_center_approver"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_company_approver"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="reportes---apiv1appreports"><strong>REPORTES - /api/v1/app/reports/</strong></h4>

<table>
  <thead>
    <tr>
      <th>Método</th>
      <th>Endpoint</th>
      <th>Descripción</th>
      <th>Autenticación</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>POST</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/reports/upload/</code></td>
      <td>Subir archivo PDF</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>POST</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/documents/&lt;id&gt;/delete/</code></td>
      <td>Marcar como eliminado</td>
      <td>Token</td>
    </tr>
  </tbody>
</table>

<p><strong>Ejemplo POST /reports/upload/</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/api/v1/app/reports/upload/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">multipart/form-data</span>

document_id=1&amp;
file=&lt;archivo.pdf&gt;
</code></pre></div></div>

<hr />

<h4 id="sap---apiv1appsap"><strong>SAP - /api/v1/app/sap/</strong></h4>

<table>
  <thead>
    <tr>
      <th>Método</th>
      <th>Endpoint</th>
      <th>Descripción</th>
      <th>Autenticación</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>GET</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/sap/documents/</code></td>
      <td>Listar documentos enviados a SAP</td>
      <td>Token</td>
    </tr>
    <tr>
      <td><strong>POST</strong></td>
      <td><code class="language-plaintext highlighter-rouge">/sap/documents/send/</code></td>
      <td>Enviar documento a SAP</td>
      <td>Token</td>
    </tr>
  </tbody>
</table>

<p><strong>Ejemplo GET /sap/documents/</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/api/v1/app/sap/documents/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6</span>
</code></pre></div></div>

<hr />

<h3 id="54-respuestas-estándar-success-error">5.4 Respuestas Estándar (Success, Error)</h3>

<h4 id="formato-jsend"><strong>Formato JSend</strong></h4>

<p>La API utiliza estándar <strong>JSend</strong> para respuestas consistentes.</p>

<h5 id="respuesta-exitosa"><strong>Respuesta Exitosa</strong></h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Documento"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-11-30T10:30:00Z"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Casos:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">GET /documents/</code> → 200 OK</li>
  <li><code class="language-plaintext highlighter-rouge">POST /documents/</code> → 201 Created</li>
  <li><code class="language-plaintext highlighter-rouge">PATCH /documents/&lt;id&gt;/</code> → 200 OK</li>
  <li><code class="language-plaintext highlighter-rouge">DELETE /documents/&lt;id&gt;/</code> → 204 No Content</li>
</ul>

<h5 id="respuesta-de-error-de-validación"><strong>Respuesta de Error de Validación</strong></h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fail"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Validation error"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Este campo es requerido."</span><span class="p">],</span><span class="w">
    </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Este valor debe ser un decimal válido."</span><span class="p">],</span><span class="w">
    </span><span class="nl">"expense_concept"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Este objeto no existe."</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>HTTP Status:</strong> 400 Bad Request</p>

<h5 id="respuesta-de-error-de-autorización"><strong>Respuesta de Error de Autorización</strong></h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fail"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Permission denied"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"You do not have permission to perform this action."</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>HTTP Status:</strong> 403 Forbidden</p>

<h5 id="respuesta-de-error-de-autenticación"><strong>Respuesta de Error de Autenticación</strong></h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fail"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Authentication failed"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid token."</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>HTTP Status:</strong> 401 Unauthorized</p>

<h5 id="respuesta-de-recurso-no-encontrado"><strong>Respuesta de Recurso No Encontrado</strong></h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fail"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Not found"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Document not found."</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>HTTP Status:</strong> 404 Not Found</p>

<h5 id="respuesta-de-error-de-servidor"><strong>Respuesta de Error de Servidor</strong></h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"error"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"An error occurred"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>HTTP Status:</strong> 500 Internal Server Error</p>

<p><strong>Nota:</strong> Stack trace se envía a Sentry (no al cliente)</p>

<hr />

<h3 id="55-manejo-de-errores-y-validaciones">5.5 Manejo de Errores y Validaciones</h3>

<h4 id="niveles-de-validación"><strong>Niveles de Validación</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Serializer Level (DRF)
   ├─ Campo requerido
   ├─ Tipo de dato
   ├─ Rango/length
   └─ Validadores custom

2. Model Level (Django)
   ├─ clean() method
   ├─ Constraints
   └─ Foreign Key existence

3. Business Logic Level (Services)
   ├─ Reglas de negocio
   ├─ Permisos
   └─ Estados válidos

4. Database Level
   ├─ Integrity constraints
   ├─ Unique constraints
   └─ Foreign key constraints
</code></pre></div></div>

<h4 id="ejemplo-validación-de-gasto"><strong>Ejemplo: Validación de Gasto</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># serializers.py
</span><span class="k">class</span> <span class="nc">DocumentExpenseSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">DocumentExpense</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'title'</span><span class="p">,</span> <span class="s">'description'</span><span class="p">,</span> <span class="s">'amount'</span><span class="p">,</span> <span class="s">'tax'</span><span class="p">,</span> <span class="s">'currency'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"Título no puede estar vacío"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">validate_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"Monto debe ser mayor a 0"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">10000000</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"Monto excede límite de $10M"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Validación entre campos
</span>        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">'tax'</span><span class="p">].</span><span class="n">company</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s">'currency'</span><span class="p">].</span><span class="n">company</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="p">.</span><span class="n">ValidationError</span><span class="p">({</span>
                <span class="s">'tax'</span><span class="p">:</span> <span class="s">"Impuesto no válido para esta moneda"</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">data</span>

<span class="c1"># models.py
</span><span class="k">class</span> <span class="nc">DocumentExpense</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ... campos ...
</span>
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Validación a nivel de modelo
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">recorded_subtotal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Subtotal no puede ser negativo"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="códigos-de-error-http-comunes"><strong>Códigos de Error HTTP Comunes</strong></h4>

<table>
  <thead>
    <tr>
      <th>Código</th>
      <th>Significado</th>
      <th>Ejemplo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>400</strong></td>
      <td>Bad Request</td>
      <td>Validación fallida</td>
    </tr>
    <tr>
      <td><strong>401</strong></td>
      <td>Unauthorized</td>
      <td>Token inválido o ausente</td>
    </tr>
    <tr>
      <td><strong>403</strong></td>
      <td>Forbidden</td>
      <td>Falta de permisos</td>
    </tr>
    <tr>
      <td><strong>404</strong></td>
      <td>Not Found</td>
      <td>Recurso no existe</td>
    </tr>
    <tr>
      <td><strong>409</strong></td>
      <td>Conflict</td>
      <td>Violación de constraints</td>
    </tr>
    <tr>
      <td><strong>422</strong></td>
      <td>Unprocessable Entity</td>
      <td>Datos inválidos para procesamiento</td>
    </tr>
    <tr>
      <td><strong>500</strong></td>
      <td>Internal Server Error</td>
      <td>Error no manejado</td>
    </tr>
    <tr>
      <td><strong>503</strong></td>
      <td>Service Unavailable</td>
      <td>Base de datos caída</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="56-ejemplos-de-requestresponse-por-endpoint">5.6 Ejemplos de Request/Response por Endpoint</h3>

<h4 id="1-crear-documento-completo"><strong>1. Crear Documento Completo</strong></h4>

<p><strong>Request:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/api/v1/app/documents/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token abc123...</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">multipart/form-data; boundary=----WebKitFormBoundary</span>

------WebKitFormBoundary
Content-Disposition: form-data; name="document[title]"

Viaje a Valparaíso
------WebKitFormBoundary
Content-Disposition: form-data; name="document[description]"

Viaje de trabajo a cliente principal
------WebKitFormBoundary
Content-Disposition: form-data; name="document[cost_center_id]"

1
------WebKitFormBoundary
Content-Disposition: form-data; name="document[document_date]"

2025-11-30T10:00:00Z
------WebKitFormBoundary
Content-Disposition: form-data; name="expenses[0][title]"

Pasaje aéreo
------WebKitFormBoundary
Content-Disposition: form-data; name="expenses[0][amount]"

500000
------WebKitFormBoundary
Content-Disposition: form-data; name="expenses[0][tax_id]"

1
------WebKitFormBoundary
Content-Disposition: form-data; name="expenses[0][currency_id]"

1
------WebKitFormBoundary
Content-Disposition: form-data; name="expenses[0][expense_concept_id]"

2
------WebKitFormBoundary
Content-Disposition: form-data; name="expenses[0][supplier_id]"

5
------WebKitFormBoundary
Content-Disposition: form-data; name="travels[0][route_id]"

3
------WebKitFormBoundary
Content-Disposition: form-data; name="travels[0][total]"

150000
------WebKitFormBoundary--
</code></pre></div></div>

<p><strong>Response:</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Viaje a Valparaíso"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Viaje de trabajo a cliente principal"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SAVED"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"recorded_total"</span><span class="p">:</span><span class="w"> </span><span class="mf">650000.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"converted_total"</span><span class="p">:</span><span class="w"> </span><span class="mf">650000.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"expense"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pasaje aéreo"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="mi">500000</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"travel"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Viaje"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="mi">150000</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="2-enviar-documento-a-aprobación"><strong>2. Enviar Documento a Aprobación</strong></h4>

<p><strong>Request:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/api/v1/app/documents/42/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token abc123...</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PENDING"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Response:</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w">
    </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PENDING"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Document sent for approval"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="3-aprobar-gasto"><strong>3. Aprobar Gasto</strong></h4>

<p><strong>Request:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/api/v1/app/approvals/expenses/100/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token approver_token...</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"is_approved"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Aprobado. Monto dentro de política."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Response:</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pasaje aéreo"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_approved"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"approval_level"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Expense approved at level 1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="4-rechazar-gasto"><strong>4. Rechazar Gasto</strong></h4>

<p><strong>Request:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/api/v1/app/approvals/expenses/100/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token approver_token...</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"is_approved"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Rechazado: No hay justificación suficiente para este monto."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Response:</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fail"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Expense rejected"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_approved"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"approval_level"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Rechazado: No hay justificación..."</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="5-listar-historial-de-aprobaciones"><strong>5. Listar Historial de Aprobaciones</strong></h4>

<p><strong>Request:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/api/v1/app/approvals/history/?page=1</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Token approver_token...</span>
</code></pre></div></div>

<p><strong>Response:</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"operation_date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-11-30T15:45:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_approved"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Aprobado"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"approver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"carlos.supervisor"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"object_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DocumentExpense"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"object_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
      </span><span class="nl">"object_title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pasaje aéreo"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"operation_date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-11-30T16:30:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_approved"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OK"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"approver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"maria.gerente"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"object_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DocumentExpense"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"object_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
      </span><span class="nl">"object_title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pasaje aéreo"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"pagination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w">
    </span><span class="nl">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"?page=2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"previous"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h2 id="resumen-de-api">Resumen de API</h2>

<table>
  <thead>
    <tr>
      <th>Aspecto</th>
      <th>Detalles</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Versión</strong></td>
      <td>v1 (versionado en URL)</td>
    </tr>
    <tr>
      <td><strong>Formato</strong></td>
      <td>JSON + JSend</td>
    </tr>
    <tr>
      <td><strong>Autenticación</strong></td>
      <td>Token (DRF)</td>
    </tr>
    <tr>
      <td><strong>Autorización</strong></td>
      <td>Permisos granulares</td>
    </tr>
    <tr>
      <td><strong>Paginación</strong></td>
      <td>15 items por página</td>
    </tr>
    <tr>
      <td><strong>Filtrado</strong></td>
      <td>Query parameters</td>
    </tr>
    <tr>
      <td><strong>Total Endpoints</strong></td>
      <td>25+ endpoints</td>
    </tr>
    <tr>
      <td><strong>Validación</strong></td>
      <td>3 niveles (Serializer, Model, Business)</td>
    </tr>
    <tr>
      <td><strong>Errores</strong></td>
      <td>Códigos HTTP estándar + JSend</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="6-servicios--casos-de-uso">6. Servicios / Casos de Uso</h2>

<h3 id="61-lógica-de-negocio-central">6.1 Lógica de Negocio Central</h3>

<h4 id="flujos-principales"><strong>Flujos Principales</strong></h4>

<h5 id="a-creación-de-documento"><strong>A. Creación de Documento</strong></h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Usuario crea documento
    ↓
[SAVED] - Borrador editable
    ↓
Usuario agrega gastos, viajes, viáticos
    ↓ (por cada item)
Calcula totales automáticamente
    ↓
Usuario marca como PENDING
    ↓
[PENDING] - Enviar a aprobación
    ↓
Aprobadores revisan
    ↓
Niveles de aprobación (1, 2, 3)
    ↓
Si todo se aprueba en nivel actual → avanza nivel
    ↓
Si rechaza en cualquier nivel → vuelta a SAVED
    ↓
Nivel 3 completo → [APPROVED]
    ↓
[APPROVED] - Listo para pago
</code></pre></div></div>

<h5 id="b-flujo-de-aprobación-multi-nivel"><strong>B. Flujo de Aprobación (Multi-nivel)</strong></h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Level 1: Aprobador directo del usuario (UserApprover)
         ├─ Aprueba gastos del usuario
         └─ Solo ve sus users

Level 2: Aprobador por Centro de Costo (CostCenterApprover)
         ├─ Aprueba gastos del ceco
         └─ Solo ve sus cecos

Level 3: Aprobador por Empresa (CompanyApprover)
         ├─ Aprueba gastos de la empresa
         └─ Solo ve sus empresas
</code></pre></div></div>

<p><strong>Lógica de Avance:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cuando TODOS los items (expenses, travels, perdiems)
están aprobados en nivel N:
    → Sistema crea ApprovalHistory automática para nivel N
    → Si N &lt; 3: estado permanece PENDING (espera nivel N+1)
    → Si N == 3: estado cambia a APPROVED
</code></pre></div></div>

<hr />

<h3 id="62-servicios-reutilizables">6.2 Servicios Reutilizables</h3>

<h4 id="1-dashboardemployeeservice"><strong>1. DashboardEmployeeService</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/services/dashboard_service.py</code></p>

<p><strong>Propósito:</strong> Generar datos de dashboard para empleados</p>

<p><strong>Métodos:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DashboardEmployeeService</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="c1"># Inicializa con usuario actual
</span>
    <span class="k">def</span> <span class="nf">get_bar_chart_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Gráfico de barras por concepto de gasto (mes actual)"""</span>
        <span class="c1"># Retorna top 5 conceptos de gasto
</span>        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"Alimentación"</span><span class="p">,</span> <span class="s">"count"</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
            <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"Transporte"</span><span class="p">,</span> <span class="s">"count"</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
            <span class="p">...</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_emissions_pie_chart_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Gráfico pie de tipos de gasto"""</span>
        <span class="c1"># Distribución: Gastos, Viajes, Viáticos
</span>        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"labels"</span><span class="p">:</span> <span class="p">[</span><span class="s">"Expenses"</span><span class="p">,</span> <span class="s">"Travels"</span><span class="p">,</span> <span class="s">"PerDiems"</span><span class="p">],</span>
            <span class="s">"values"</span><span class="p">:</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_expense_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Lista formateada de últimos 10 gastos del mes"""</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s">"expense"</span><span class="p">:</span> <span class="s">"Hotel"</span><span class="p">,</span>
                <span class="s">"category"</span><span class="p">:</span> <span class="s">"Hospedaje"</span><span class="p">,</span>
                <span class="s">"amount"</span><span class="p">:</span> <span class="s">"250000.00 CLP"</span><span class="p">,</span>
                <span class="s">"status"</span><span class="p">:</span> <span class="s">"APPROVED"</span><span class="p">,</span>
                <span class="s">"date"</span><span class="p">:</span> <span class="s">"30/11/2025"</span>
            <span class="p">},</span>
            <span class="p">...</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_payment_status_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Estado de pago de gastos aprobados"""</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s">"amount"</span><span class="p">:</span> <span class="s">"250000.00 CLP"</span><span class="p">,</span>
                <span class="s">"situation"</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>  <span class="c1"># Pagado
</span>                <span class="s">"date"</span><span class="p">:</span> <span class="s">"30/11/2025"</span>
            <span class="p">},</span>
            <span class="p">...</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_stats_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Estadísticas comparadas mes anterior"""</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"travels"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"amount"</span><span class="p">:</span> <span class="mf">1500000.0</span><span class="p">,</span>
                <span class="s">"percentage"</span><span class="p">:</span> <span class="mf">15.5</span><span class="p">,</span>
                <span class="s">"trend"</span><span class="p">:</span> <span class="s">"up"</span>
            <span class="p">},</span>
            <span class="s">"perdiem"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"amount"</span><span class="p">:</span> <span class="mf">300000.0</span><span class="p">,</span>
                <span class="s">"percentage"</span><span class="p">:</span> <span class="mf">8.2</span><span class="p">,</span>
                <span class="s">"trend"</span><span class="p">:</span> <span class="s">"down"</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<p><strong>Uso:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># En view
</span><span class="n">dashboard</span> <span class="o">=</span> <span class="n">DashboardEmployeeService</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"barChart"</span><span class="p">:</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">get_bar_chart_data</span><span class="p">(),</span>
    <span class="s">"pieChart"</span><span class="p">:</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">get_emissions_pie_chart_data</span><span class="p">(),</span>
    <span class="s">"expenses"</span><span class="p">:</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">get_expense_data</span><span class="p">(),</span>
    <span class="s">"payments"</span><span class="p">:</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">get_payment_status_data</span><span class="p">(),</span>
    <span class="s">"stats"</span><span class="p">:</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">get_stats_data</span><span class="p">()</span>
<span class="p">}</span>
<span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h4 id="2-approvalservice"><strong>2. ApprovalService</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/services/appraisal_service.py</code></p>

<p><strong>Propósito:</strong> Orquestar lógica de aprobación multi-nivel</p>

<p><strong>Métodos Principales:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApprovalService</span><span class="p">:</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">process_expense_approval</span><span class="p">(</span><span class="n">expense</span><span class="p">,</span> <span class="n">approver</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">is_approved</span><span class="p">,</span> <span class="n">comments</span><span class="p">):</span>
        <span class="s">"""
        Procesa la aprobación de un gasto en un nivel específico

        1. Valida que el approver tiene permisos
        2. Crea registro en ApprovalHistory
        3. Si es aprobado: verifica si todos están aprobados en este nivel
        4. Si todo aprobado: avanza automáticamente
        5. Si es rechazado: marca documento como SAVED para re-edición
        """</span>
        <span class="c1"># Validación de permisos
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_approver_permission</span><span class="p">(</span><span class="n">approver</span><span class="p">,</span> <span class="n">expense</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PermissionDenied</span><span class="p">(</span><span class="s">"No permission to approve"</span><span class="p">)</span>

        <span class="c1"># Crear registro de aprobación
</span>        <span class="n">approval</span> <span class="o">=</span> <span class="n">ApprovalHistory</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">DocumentExpense</span><span class="p">),</span>
            <span class="n">object_id</span><span class="o">=</span><span class="n">expense</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">approver</span><span class="o">=</span><span class="n">approver</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="n">is_approved</span><span class="p">,</span>
            <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">,</span>
            <span class="n">document</span><span class="o">=</span><span class="n">expense</span><span class="p">.</span><span class="n">document</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_approved</span><span class="p">:</span>
            <span class="c1"># Si todos están aprobados en este nivel
</span>            <span class="c1"># → avanza automáticamente al siguiente
</span>            <span class="k">return</span> <span class="n">_check_and_advance_document_level</span><span class="p">(</span><span class="n">expense</span><span class="p">.</span><span class="n">document</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Si rechaza: documento vuelve a SAVED
</span>            <span class="n">expense</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="s">'SAVED'</span>
            <span class="n">expense</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"Expense rejected. Document returned to SAVED."</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">process_travel_approval</span><span class="p">(</span><span class="n">travel</span><span class="p">,</span> <span class="n">approver</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">is_approved</span><span class="p">,</span> <span class="n">comments</span><span class="p">):</span>
        <span class="s">"""Similar a process_expense_approval pero para DocumentTravel"""</span>
        <span class="c1"># ... lógica similar
</span>
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">process_perdiem_approval</span><span class="p">(</span><span class="n">perdiem</span><span class="p">,</span> <span class="n">approver</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">is_approved</span><span class="p">,</span> <span class="n">comments</span><span class="p">):</span>
        <span class="s">"""Similar a process_expense_approval pero para DocumentPerDiem"""</span>
        <span class="c1"># ... lógica similar
</span>
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">get_approvable_documents</span><span class="p">(</span><span class="n">approver</span><span class="p">):</span>
        <span class="s">"""
        Retorna documentos que el approver puede aprobar
        basado en:
        - UserApprover: usuarios asignados
        - CostCenterApprover: centros de costo asignados
        - CompanyApprover: empresas asignadas

        Filtra solo PENDING con items sin aprobar
        """</span>
        <span class="c1"># Obtener docs de usuarios asignados
</span>        <span class="n">user_docs</span> <span class="o">=</span> <span class="n">Document</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
            <span class="n">user__in</span><span class="o">=</span><span class="n">UserApprover</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">approver</span>
            <span class="p">).</span><span class="n">values_list</span><span class="p">(</span><span class="s">'can_approve_for'</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Obtener docs de cecos asignados
</span>        <span class="n">ceco_docs</span> <span class="o">=</span> <span class="n">Document</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
            <span class="n">cost_center__in</span><span class="o">=</span><span class="n">CostCenterApprover</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">approver</span>
            <span class="p">).</span><span class="n">values_list</span><span class="p">(</span><span class="s">'cost_center'</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Obtener docs de empresas asignadas
</span>        <span class="n">company_docs</span> <span class="o">=</span> <span class="n">Document</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
            <span class="n">enterprise__in</span><span class="o">=</span><span class="n">CompanyApprover</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">approver</span>
            <span class="p">).</span><span class="n">values_list</span><span class="p">(</span><span class="s">'company'</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Unir y filtrar PENDING
</span>        <span class="k">return</span> <span class="p">(</span><span class="n">user_docs</span> <span class="o">|</span> <span class="n">ceco_docs</span> <span class="o">|</span> <span class="n">company_docs</span><span class="p">).</span><span class="nb">filter</span><span class="p">(</span>
            <span class="n">state</span><span class="o">=</span><span class="s">'PENDING'</span><span class="p">,</span>
            <span class="n">erased_at__isnull</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">).</span><span class="n">distinct</span><span class="p">()</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">enrich_document_with_items</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
        <span class="s">"""
        Enriquece documento con sus items (expenses, travels, perdiems)
        y estado de aprobación
        """</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"id"</span><span class="p">:</span> <span class="n">document</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="s">"title"</span><span class="p">:</span> <span class="n">document</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s">"items"</span><span class="p">:</span> <span class="p">[</span>
                <span class="o">*</span><span class="n">_get_document_expenses_with_status</span><span class="p">(</span><span class="n">document</span><span class="p">),</span>
                <span class="o">*</span><span class="n">_get_document_travels_with_status</span><span class="p">(</span><span class="n">document</span><span class="p">),</span>
                <span class="o">*</span><span class="n">_get_document_perdiems_with_status</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">}</span>
</code></pre></div></div>

<p><strong>Validación de Permisos Internos:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_check_approver_permission</span><span class="p">(</span><span class="n">approver</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
    <span class="s">"""
    Verifica si approver puede aprobar un item en un nivel

    Level 1: UserApprover
    Level 2: CostCenterApprover
    Level 3: CompanyApprover
    """</span>
    <span class="n">document</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">document</span>

    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># ¿Approver está en UserApprover para este usuario?
</span>        <span class="k">return</span> <span class="n">UserApprover</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">approver</span><span class="p">,</span>
            <span class="n">can_approve_for</span><span class="o">=</span><span class="n">document</span><span class="p">.</span><span class="n">user</span>
        <span class="p">).</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># ¿Approver está en CostCenterApprover para este ceco?
</span>        <span class="k">return</span> <span class="n">CostCenterApprover</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">approver</span><span class="p">,</span>
            <span class="n">cost_center</span><span class="o">=</span><span class="n">document</span><span class="p">.</span><span class="n">cost_center</span>
        <span class="p">).</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># ¿Approver está en CompanyApprover para esta empresa?
</span>        <span class="k">return</span> <span class="n">CompanyApprover</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">approver</span><span class="p">,</span>
            <span class="n">company</span><span class="o">=</span><span class="n">document</span><span class="p">.</span><span class="n">enterprise</span>
        <span class="p">).</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<hr />

<h4 id="3-approverdashboardservice"><strong>3. ApproverDashboardService</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/services/approver_dashboard_service.py</code></p>

<p><strong>Propósito:</strong> Dashboards específicos para cada tipo de aprobador</p>

<p><strong>Clases:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UserApproverDashboardService</span><span class="p">:</span>
    <span class="s">"""Para aprobadores por usuario"""</span>
    <span class="k">def</span> <span class="nf">get_stats_cards_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Aprobaciones este mes vs mes anterior
</span>
    <span class="k">def</span> <span class="nf">get_employees_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Lista de empleados que puede aprobar
</span>
    <span class="k">def</span> <span class="nf">get_pending_approvals_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Documentos pendientes de su aprobación
</span>
    <span class="k">def</span> <span class="nf">get_expense_chart_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Gráfico de gastos a aprobar
</span>
<span class="k">class</span> <span class="nc">CostCenterApproverDashboardService</span><span class="p">:</span>
    <span class="s">"""Para aprobadores por centro de costo"""</span>
    <span class="k">def</span> <span class="nf">get_stats_cards_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Aprobaciones por ceco
</span>
    <span class="k">def</span> <span class="nf">get_cost_centers_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Lista de cecos que puede aprobar
</span>
    <span class="k">def</span> <span class="nf">get_pending_approvals_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Documentos pendientes por ceco
</span>
<span class="k">class</span> <span class="nc">CompanyApproverDashboardService</span><span class="p">:</span>
    <span class="s">"""Para aprobadores por empresa"""</span>
    <span class="k">def</span> <span class="nf">get_stats_cards_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Aprobaciones por empresa
</span>
    <span class="k">def</span> <span class="nf">get_companies_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Lista de empresas que puede aprobar
</span>
    <span class="k">def</span> <span class="nf">get_pending_approvals_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Documentos pendientes por empresa
</span></code></pre></div></div>

<hr />

<h4 id="4-documentbuilder"><strong>4. DocumentBuilder</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/builder/builder.py</code></p>

<p><strong>Propósito:</strong> Construcción compleja de documentos con validación</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DocumentBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">document</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">create_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="s">"""
        Crea documento base

        Calcula:
        - recorded_subtotal = 0
        - recorded_total = 0
        - converted_subtotal = 0
        - converted_total = 0
        """</span>
        <span class="n">cost_center</span> <span class="o">=</span> <span class="n">CostCenter</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">"access"</span><span class="p">].</span><span class="n">cost_center</span><span class="p">)</span>
        <span class="n">enterprise</span> <span class="o">=</span> <span class="n">cost_center</span><span class="p">.</span><span class="n">company</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">document</span> <span class="o">=</span> <span class="n">Document</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">"title"</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">"description"</span><span class="p">],</span>
            <span class="n">document_date</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">"document_date"</span><span class="p">],</span>
            <span class="n">recorded_subtotal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">recorded_total</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">converted_subtotal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">converted_total</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">"state"</span><span class="p">],</span>
            <span class="n">enterprise</span><span class="o">=</span><span class="n">enterprise</span><span class="p">,</span>
            <span class="n">cost_center</span><span class="o">=</span><span class="n">cost_center</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_expense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expense_data</span><span class="p">):</span>
        <span class="s">"""
        Agrega gasto y recalcula totales

        1. Obtiene tasa de cambio si moneda ≠ base_currency
        2. Calcula: total = subtotal * (1 + tax%)
        3. Convierte a base_currency
        4. Crea DocumentExpense
        5. Actualiza Document.totales
        """</span>
        <span class="n">tax</span> <span class="o">=</span> <span class="n">expense_data</span><span class="p">[</span><span class="s">"tax"</span><span class="p">]</span>
        <span class="n">recorded_total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expense_data</span><span class="p">[</span><span class="s">"recorded_subtotal"</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">tax</span><span class="p">.</span><span class="n">percentage</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">base_currency</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">base_currency</span>
        <span class="n">converted_subtotal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expense_data</span><span class="p">[</span><span class="s">"recorded_subtotal"</span><span class="p">])</span>
        <span class="n">converted_total</span> <span class="o">=</span> <span class="n">recorded_total</span>

        <span class="k">if</span> <span class="n">base_currency</span> <span class="o">!=</span> <span class="n">expense_data</span><span class="p">[</span><span class="s">"currency"</span><span class="p">]:</span>
            <span class="c1"># Obtener tasa de cambio
</span>            <span class="n">exchange_rate</span> <span class="o">=</span> <span class="n">ExchangeRateService</span><span class="p">().</span><span class="n">get_rate</span><span class="p">(</span>
                <span class="n">base_currency</span><span class="p">,</span>
                <span class="n">expense_data</span><span class="p">[</span><span class="s">"currency"</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">converted_subtotal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expense_data</span><span class="p">[</span><span class="s">"recorded_subtotal"</span><span class="p">])</span> <span class="o">/</span> <span class="n">exchange_rate</span>
            <span class="n">converted_total</span> <span class="o">=</span> <span class="n">recorded_total</span> <span class="o">/</span> <span class="n">exchange_rate</span>

        <span class="c1"># Actualizar totales del documento
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">recorded_subtotal</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'recorded_subtotal'</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">recorded_total</span> <span class="o">+=</span> <span class="n">recorded_total</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">converted_subtotal</span> <span class="o">+=</span> <span class="n">converted_subtotal</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">converted_total</span> <span class="o">+=</span> <span class="n">converted_total</span>

        <span class="c1"># Crear gasto
</span>        <span class="n">DocumentExpense</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'description'</span><span class="p">],</span>
            <span class="n">expense_date</span><span class="o">=</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'expense_date'</span><span class="p">],</span>
            <span class="n">expense_type</span><span class="o">=</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'expense_type'</span><span class="p">],</span>
            <span class="n">recorded_subtotal</span><span class="o">=</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'recorded_subtotal'</span><span class="p">],</span>
            <span class="n">converted_subtotal</span><span class="o">=</span><span class="n">converted_subtotal</span><span class="p">,</span>
            <span class="n">recorded_total</span><span class="o">=</span><span class="n">recorded_total</span><span class="p">,</span>
            <span class="n">converted_total</span><span class="o">=</span><span class="n">converted_total</span><span class="p">,</span>
            <span class="n">document</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">document</span><span class="p">,</span>
            <span class="n">supplier</span><span class="o">=</span><span class="n">expense_data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'supplier'</span><span class="p">),</span>
            <span class="n">expense_concept</span><span class="o">=</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'expense_concept'</span><span class="p">],</span>
            <span class="n">currency</span><span class="o">=</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'currency'</span><span class="p">],</span>
            <span class="n">tax</span><span class="o">=</span><span class="n">tax</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_travel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">travel_data</span><span class="p">):</span>
        <span class="s">"""Agrega viaje"""</span>
        <span class="c1"># Similar a add_expense
</span>        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">add_per_diem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perdiem_data</span><span class="p">):</span>
        <span class="s">"""Agrega viático"""</span>
        <span class="c1"># Similar a add_expense
</span>        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Retorna documento construido"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">document</span>
</code></pre></div></div>

<p><strong>Uso:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span> <span class="o">=</span> <span class="n">DocumentBuilder</span><span class="p">()</span>
<span class="n">document</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">create_document</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> \
    <span class="p">.</span><span class="n">add_expense</span><span class="p">(</span><span class="n">expense_data</span><span class="p">)</span> \
    <span class="p">.</span><span class="n">add_travel</span><span class="p">(</span><span class="n">travel_data</span><span class="p">)</span> \
    <span class="p">.</span><span class="n">add_per_diem</span><span class="p">(</span><span class="n">perdiem_data</span><span class="p">)</span> \
    <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h3 id="63-trabajo-asíncrono-si-aplica-celery-workers-cron-jobs">6.3 Trabajo Asíncrono (Si Aplica: Celery, Workers, Cron Jobs)</h3>

<h4 id="actualmente-no-implementado-pensado-para-desarrollo-en-el-futuro"><strong>Actualmente No Implementado, pensado para desarrollo en el futuro</strong></h4>

<p>Con Celery:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Tareas pendientes de implementar
</span>
<span class="o">@</span><span class="n">shared_task</span>
<span class="k">def</span> <span class="nf">send_approval_notification</span><span class="p">(</span><span class="n">approval_id</span><span class="p">):</span>
    <span class="s">"""
    Enviar notificación de aprobación/rechazo
    Triggers: cuando se crea ApprovalHistory
    Async: true
    Retry: 3 veces
    """</span>
    <span class="k">pass</span>

<span class="o">@</span><span class="n">shared_task</span>
<span class="k">def</span> <span class="nf">send_document_reminder</span><span class="p">():</span>
    <span class="s">"""
    Enviar recordatorio de documentos pendientes
    Schedule: Diariamente a las 9:00 AM
    Cron: "0 9 * * *"
    """</span>
    <span class="k">pass</span>

<span class="o">@</span><span class="n">shared_task</span>
<span class="k">def</span> <span class="nf">sync_documents_to_sap</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="n">document_id</span><span class="p">):</span>
    <span class="s">"""
    Enviar documento a SAP (puede tomar tiempo)
    Triggers: cuando estado = APPROVED y marked_for_sap = true
    Async: true
    Retry: 5 veces con backoff
    """</span>
    <span class="k">pass</span>

<span class="o">@</span><span class="n">shared_task</span>
<span class="k">def</span> <span class="nf">generate_monthly_report</span><span class="p">(</span><span class="n">company_id</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="s">"""
    Generar reporte mensual de gastos
    Schedule: Primer día del mes a las 00:00 AM
    Async: true
    """</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p><strong>Configuración Recomendada (settings.py):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CELERY_BROKER_URL</span> <span class="o">=</span> <span class="s">'redis://localhost:6379'</span>
<span class="n">CELERY_RESULT_BACKEND</span> <span class="o">=</span> <span class="s">'redis://localhost:6379'</span>
<span class="n">CELERY_ACCEPT_CONTENT</span> <span class="o">=</span> <span class="p">[</span><span class="s">'json'</span><span class="p">]</span>
<span class="n">CELERY_TASK_SERIALIZER</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">CELERY_RESULT_SERIALIZER</span> <span class="o">=</span> <span class="s">'json'</span>
<span class="n">CELERY_TIMEZONE</span> <span class="o">=</span> <span class="s">'America/Santiago'</span>

<span class="n">CELERY_BEAT_SCHEDULE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'send-daily-reminders'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'task'</span><span class="p">:</span> <span class="s">'app.tasks.send_document_reminder'</span><span class="p">,</span>
        <span class="s">'schedule'</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s">'generate-monthly-report'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'task'</span><span class="p">:</span> <span class="s">'app.tasks.generate_monthly_report'</span><span class="p">,</span>
        <span class="s">'schedule'</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">day_of_month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="64-integraciones-externas-apis-de-terceros">6.4 Integraciones Externas (APIs de Terceros)</h3>

<h4 id="1-tasas-de-cambio-exchangerateservice"><strong>1. Tasas de Cambio (ExchangeRateService)</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/adapters/adapters.py</code></p>

<p><strong>Propósito:</strong> Convertir montos entre monedas</p>

<p><strong>Implementación:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ExchangeRateService</span><span class="p">:</span>
    <span class="s">"""
    Integración con API de tasas de cambio
    Proveedor actual: Por definir (recomendado: Fixer.io, OpenExchangeRates)
    """</span>

    <span class="n">API_URL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'EXCHANGE_RATE_API_URL'</span><span class="p">,</span> <span class="s">'https://api.example.com'</span><span class="p">)</span>
    <span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'EXCHANGE_RATE_API_KEY'</span><span class="p">)</span>
    <span class="n">CACHE_TIME</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 hora
</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cache_timestamp</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">):</span>
        <span class="s">"""
        Obtiene tasa de cambio entre dos monedas

        Retorna: float (tasa de conversión)
        Ejemplo: get_rate('USD', 'CLP') → 850.5
        """</span>
        <span class="c1"># Verificar caché
</span>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">from_currency</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">to_currency</span><span class="si">}</span><span class="s">"</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">cache_timestamp</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">CACHE_TIME</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

        <span class="c1"># Consultar API
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">API_URL</span><span class="si">}</span><span class="s">/rates"</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                    <span class="s">'from'</span><span class="p">:</span> <span class="n">from_currency</span><span class="p">,</span>
                    <span class="s">'to'</span><span class="p">:</span> <span class="n">to_currency</span><span class="p">,</span>
                    <span class="s">'apikey'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">API_KEY</span>
                <span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span>
            <span class="p">)</span>
            <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'rate'</span><span class="p">]</span>

            <span class="c1"># Guardar en caché
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">cache_timestamp</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">rate</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error fetching exchange rate: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="c1"># Fallback: retornar 1.0 o tasa anterior
</span>            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">):</span>
        <span class="s">"""
        Convierte monto entre monedas

        Ejemplo: convert(100, 'USD', 'CLP') → 85050
        """</span>
        <span class="k">if</span> <span class="n">from_currency</span> <span class="o">==</span> <span class="n">to_currency</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">amount</span>

        <span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_rate</span><span class="p">(</span><span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">rate</span>
</code></pre></div></div>

<p><strong>Uso:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># En DocumentBuilder.add_expense()
</span><span class="n">service</span> <span class="o">=</span> <span class="n">ExchangeRateService</span><span class="p">()</span>
<span class="n">converted_amount</span> <span class="o">=</span> <span class="n">service</span><span class="p">.</span><span class="n">convert</span><span class="p">(</span>
    <span class="n">amount</span><span class="o">=</span><span class="mi">250000</span><span class="p">,</span>
    <span class="n">from_currency</span><span class="o">=</span><span class="n">expense_data</span><span class="p">[</span><span class="s">'currency'</span><span class="p">],</span>
    <span class="n">to_currency</span><span class="o">=</span><span class="n">base_currency</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h4 id="2-integración-sap-sapservice"><strong>2. Integración SAP (SapService)</strong></h4>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">app/features/web/sap/views.py</code></p>

<p><strong>Propósito:</strong> Enviar documentos aprobados a SAP</p>

<p><strong>Flujo:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Usuario marca documento como APPROVED
2. Usuario accede a /sap/documents/send/
3. Backend convierte documento a formato SAP:
   - Mapea DocumentClass → SAP document type
   - Mapea ExpenseConcept → SAP account
   - Mapea AccountingAccount → SAP GL account
4. Envía POST a API SAP
5. SAP retorna external_code
6. Sistema guarda external_code en Document.external_code

Datos enviados a SAP:
{
  "document_type": "ZXP1",  # De DocumentClass.code
  "document_date": "2025-11-30",
  "items": [
    {
      "account": "1000",  # De AccountingAccount.account
      "amount": 250000.00,
      "concept": "Hospedaje",
      "supplier": "Hotel ABC"
    }
  ],
  "company_code": "1000"  # De Company.sap_code
}
</code></pre></div></div>

<p><strong>Ejemplo de Respuesta SAP:</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"document_number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FI-2025-0001234"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"posting_date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-11-30"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h4 id="3-email-notifications-futuro"><strong>3. Email Notifications (Futuro)</strong></h4>

<p><strong>Casos de Uso:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Notificación: Documento enviado a aprobación
</span><span class="n">send_email</span><span class="p">(</span>
    <span class="n">to</span><span class="o">=</span><span class="n">approver</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s">"Documento pendiente de aprobación"</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s">"approval_needed"</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="p">{</span>
        <span class="s">"document"</span><span class="p">:</span> <span class="n">document</span><span class="p">,</span>
        <span class="s">"sender"</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
        <span class="s">"approval_url"</span><span class="p">:</span> <span class="s">"..."</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Notificación: Documento aprobado
</span><span class="n">send_email</span><span class="p">(</span>
    <span class="n">to</span><span class="o">=</span><span class="n">user</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s">"Documento aprobado"</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s">"approval_success"</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="p">{</span>
        <span class="s">"document"</span><span class="p">:</span> <span class="n">document</span><span class="p">,</span>
        <span class="s">"approver"</span><span class="p">:</span> <span class="n">approver</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Notificación: Documento rechazado
</span><span class="n">send_email</span><span class="p">(</span>
    <span class="n">to</span><span class="o">=</span><span class="n">user</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s">"Documento rechazado"</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s">"approval_rejected"</span><span class="p">,</span>
    <span class="n">context</span><span class="o">=</span><span class="p">{</span>
        <span class="s">"document"</span><span class="p">:</span> <span class="n">document</span><span class="p">,</span>
        <span class="s">"approver"</span><span class="p">:</span> <span class="n">approver</span><span class="p">,</span>
        <span class="s">"comments"</span><span class="p">:</span> <span class="n">comments</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="resumen-de-servicios">Resumen de Servicios</h2>

<table>
  <thead>
    <tr>
      <th>Servicio</th>
      <th>Tipo</th>
      <th>Responsabilidad</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>DashboardEmployeeService</strong></td>
      <td>Cálculo</td>
      <td>Datos para dashboard empleado</td>
    </tr>
    <tr>
      <td><strong>ApproverDashboardService</strong></td>
      <td>Cálculo</td>
      <td>Datos para dashboards aprobadores</td>
    </tr>
    <tr>
      <td><strong>ApprovalService</strong></td>
      <td>Orquestación</td>
      <td>Lógica multi-nivel de aprobación</td>
    </tr>
    <tr>
      <td><strong>DocumentBuilder</strong></td>
      <td>Construcción</td>
      <td>Build de documentos complejos</td>
    </tr>
    <tr>
      <td><strong>ExchangeRateService</strong></td>
      <td>Integración</td>
      <td>Conversión de divisas</td>
    </tr>
    <tr>
      <td><strong>SapService</strong></td>
      <td>Integración</td>
      <td>Envío a SAP ERP</td>
    </tr>
    <tr>
      <td><strong>EmailService</strong></td>
      <td>Notificación</td>
      <td>Correos (futuro)</td>
    </tr>
    <tr>
      <td><strong>CeleryTasks</strong></td>
      <td>Async</td>
      <td>Tareas asíncronas (futuro)</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="7-seguridad">7. Seguridad</h2>

<h3 id="71-principios-aplicados-jwt-csrf-cors-etc">7.1 Principios Aplicados (JWT, CSRF, CORS, etc.)</h3>

<h4 id="a-token-authentication-no-jwt-token-drf"><strong>A. Token Authentication (No JWT, Token DRF)</strong></h4>

<p><strong>Implementación:</strong> Django REST Framework Token Authentication</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NO es JWT. Es un token opaco generado por DRF:
- Almacenado en tabla: authtoken_token
- Estructura: 40 caracteres hexadecimales aleatorios
- No contiene claims (stateless en BD)
- Sin expiración por defecto (pero se puede agregar)
</code></pre></div></div>

<p><strong>Header de Autenticación:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">Authorization: Token a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
</span></code></pre></div></div>

<p><strong>Flujo:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. POST /auth/login/ con credenciales
2. Backend valida contra modelo User
3. Backend busca o crea Token para ese User
4. Respuesta: {"token": "abc123..."}
5. Cliente almacena en localStorage
6. Cliente envía en headers de siguientes requests
7. Middleware valida token en tabla authtoken_token
8. Si válido: request.user = User asociado
9. Si inválido: Response 401 Unauthorized
</code></pre></div></div>

<p><strong>Ventajas:</strong></p>

<ul>
  <li>Simple de implementar</li>
  <li>No requiere secrets compartidos</li>
  <li>Stateless para cliente</li>
  <li>Compatible con mobile/spa</li>
</ul>

<p><strong>Desventajas:</strong></p>

<ul>
  <li>No hay expiración automática</li>
  <li>No hay refresh tokens</li>
  <li>Requiere validación en BD en cada request</li>
</ul>

<hr />

<h4 id="b-csrf-cross-site-request-forgery"><strong>B. CSRF (Cross-Site Request Forgery)</strong></h4>

<p><strong>Estado:</strong> Configurado en Django pero NO requerido en DRF</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py
</span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="p">,</span>
    <span class="c1"># ...
</span><span class="p">]</span>

<span class="c1"># tokens.py - CSRF automático
# Django genera token CSRF para cada sesión
# Se valida automáticamente en POST/PUT/DELETE form-urlencoded
</span></code></pre></div></div>

<p><strong>En API REST JSON:</strong></p>

<ul>
  <li>CSRF está DESHABILITADO porque:
    <ul>
      <li>Los tokens se validan por Authorization header</li>
      <li>Un atacante no puede forjar requests JSON desde otro dominio</li>
      <li>El navegador bloquea requests cross-origin sin CORS</li>
    </ul>
  </li>
</ul>

<p><strong>Si se requiere CSRF:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Agregar a view
</span><span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">csrf_protect</span>

<span class="o">@</span><span class="n">csrf_protect</span>  <span class="c1"># Fuerza validación CSRF
</span><span class="k">def</span> <span class="nf">sensitive_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<hr />

<h4 id="c-cors-cross-origin-resource-sharing"><strong>C. CORS (Cross-Origin Resource Sharing)</strong></h4>

<p><strong>Instalado:</strong> django-cors-headers 4.4.0</p>

<p><strong>Configuración Actual:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py
</span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'corsheaders'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">]</span>

<span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"corsheaders.middleware.CorsMiddleware"</span><span class="p">,</span>  <span class="c1"># Debe ser primero
</span>    <span class="s">"django.middleware.common.CommonMiddleware"</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">]</span>

<span class="c1"># CORS settings
</span><span class="n">CORS_ALLOWED_ORIGINS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"https://rinderline-webapp.vercel.app"</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
    <span class="n">CORS_ALLOW_ALL_ORIGINS</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># ⚠️ Solo en desarrollo
</span></code></pre></div></div>

<p><strong>Headers CORS Automáticos:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">Access-Control-Allow-Origin: https://rinderline-webapp.vercel.app
Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
Access-Control-Allow-Headers: Authorization, Content-Type
Access-Control-Allow-Credentials: true
</span></code></pre></div></div>

<p><strong>Preflight Requests:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err"># Cliente envía
OPTIONS /api/v1/app/documents/
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Authorization

# Servidor responde con headers CORS
# Cliente procede con POST
</span></code></pre></div></div>

<hr />

<h4 id="d-httpstls"><strong>D. HTTPS/TLS</strong></h4>

<p><strong>Forzado en Producción:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py (Render)
</span><span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUG</span><span class="p">:</span>
    <span class="n">SECURE_SSL_REDIRECT</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SESSION_COOKIE_SECURE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">CSRF_COOKIE_SECURE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SECURE_HSTS_SECONDS</span> <span class="o">=</span> <span class="mi">31536000</span>  <span class="c1"># 1 año
</span>    <span class="n">SECURE_HSTS_INCLUDE_SUBDOMAINS</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SECURE_HSTS_PRELOAD</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p><strong>Headers de Seguridad:</strong></p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
</span></code></pre></div></div>

<hr />

<h3 id="72-manejo-de-contraseñas-y-tokens">7.2 Manejo de Contraseñas y Tokens</h3>

<h4 id="a-hash-de-contraseñas"><strong>A. Hash de Contraseñas</strong></h4>

<p><strong>Algoritmo:</strong> PBKDF2 + SHA256 (Django default)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Cuando usuario se registra
</span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create_user</span><span class="p">(</span>
    <span class="n">username</span><span class="o">=</span><span class="s">'juan'</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s">'Segura123!'</span>  <span class="c1"># ← Se hashea automáticamente
</span><span class="p">)</span>

<span class="c1"># Django la guarda como:
# pbkdf2_sha256$600000$salt$hash
</span></code></pre></div></div>

<p><strong>Validación:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Cuando usuario hace login
</span><span class="n">user</span><span class="p">.</span><span class="n">check_password</span><span class="p">(</span><span class="s">'Segura123!'</span><span class="p">)</span>  <span class="c1"># True
</span><span class="n">user</span><span class="p">.</span><span class="n">check_password</span><span class="p">(</span><span class="s">'WrongPass'</span><span class="p">)</span>   <span class="c1"># False
</span>
<span class="c1"># Usa algoritmo PBKDF2 configurado
</span></code></pre></div></div>

<p><strong>Configuración:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py
</span><span class="n">PASSWORD_HASHERS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'django.contrib.auth.hashers.PBKDF2PasswordHasher'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth.hashers.Argon2PasswordHasher'</span><span class="p">,</span>  <span class="c1"># Más fuerte
</span>    <span class="s">'django.contrib.auth.hashers.BCryptSHA256PasswordHasher'</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">PASSWORD_VALIDATORS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'django.contrib.auth.password_validation.MinimumLengthValidator'</span><span class="p">,</span>
        <span class="s">'OPTIONS'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'min_length'</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'django.contrib.auth.password_validation.CommonPasswordValidator'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="s">'django.contrib.auth.password_validation.NumericPasswordValidator'</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
</code></pre></div></div>

<p><strong>Mejora Recomendada:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Cambiar a Argon2 (más seguro)
# pip install argon2-cffi
</span>
<span class="n">PASSWORD_HASHERS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'django.contrib.auth.hashers.Argon2PasswordHasher'</span><span class="p">,</span>  <span class="c1"># Primero
</span>    <span class="s">'django.contrib.auth.hashers.PBKDF2PasswordHasher'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">]</span>
</code></pre></div></div>

<hr />

<h4 id="b-token-storage"><strong>B. Token Storage</strong></h4>

<p><strong>En Base de Datos:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># authtoken/models.py
</span><span class="k">class</span> <span class="nc">Token</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="n">User</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s">'auth_token'</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="p">.</span><span class="n">CASCADE</span>
    <span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Generación:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework.authtoken.models</span> <span class="kn">import</span> <span class="n">Token</span>

<span class="c1"># Al login
</span><span class="n">token</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Token</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

<span class="c1"># Si token ya existe, se reutiliza
# Si necesitas nuevo: Token.objects.filter(user=user).delete()
</span></code></pre></div></div>

<p><strong>Almacenamiento en Cliente (Frontend):</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// En localStorage (NO seguro contra XSS)</span>
<span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">authToken</span><span class="dl">"</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>

<span class="c1">// En sessionStorage (se borra al cerrar navegador)</span>
<span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">authToken</span><span class="dl">"</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>

<span class="c1">// En Cookie httpOnly (mejor, pero requiere CSRF)</span>
<span class="c1">// (Backend debe configurar)</span>
</code></pre></div></div>

<hr />

<h4 id="c-token-logout"><strong>C. Token Logout</strong></h4>

<p><strong>Implementación Actual:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># auth.py
</span><span class="o">@</span><span class="n">action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'post'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">auth_token</span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s">'detail'</span><span class="p">:</span> <span class="s">'Logged out'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s">'detail'</span><span class="p">:</span> <span class="s">'Invalid token'</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Flujo:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Cliente envía POST /auth/logout/ con token en header
2. Backend identifica al usuario del token
3. Backend elimina Token de BD
4. Token ya no es válido
5. Próximas requests con ese token → 401 Unauthorized
</code></pre></div></div>

<hr />

<h3 id="73-sanitización-y-validaciones">7.3 Sanitización y Validaciones</h3>

<h4 id="a-validación-de-entrada"><strong>A. Validación de Entrada</strong></h4>

<p><strong>Niveles:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Serializer Level (DRF)
   - max_length
   - regex patterns
   - custom validators

2. Model Level (Django)
   - clean() method
   - Constraints

3. Business Logic Level
   - Reglas de negocio
   - Permisos
</code></pre></div></div>

<p><strong>Ejemplo: Validación de DocumentExpense</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># serializers.py
</span><span class="k">class</span> <span class="nc">DocumentExpenseSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">DocumentExpense</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'title'</span><span class="p">,</span> <span class="s">'amount'</span><span class="p">,</span> <span class="s">'tax'</span><span class="p">,</span> <span class="s">'currency'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Evitar inyección SQL
</span>        <span class="k">if</span> <span class="s">'&lt;script&gt;'</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Invalid characters in title"</span><span class="p">)</span>

        <span class="c1"># Validar longitud
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Title too long"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">validate_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Validar número positivo
</span>        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Amount must be positive"</span><span class="p">)</span>

        <span class="c1"># Validar límite razonable
</span>        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">'99999999.9999999999'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Amount exceeds maximum"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Validación entre campos
</span>        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">'tax'</span><span class="p">].</span><span class="n">company</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s">'currency'</span><span class="p">].</span><span class="n">company</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Tax and currency mismatch"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div></div>

<p><strong>Tipos de Inyección Prevenidos:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. SQL Injection
   ✓ Django ORM escapea automáticamente
   ✗ Si usas raw SQL: usar parametrized queries

2. XSS (Cross-Site Scripting)
   ✓ Serializers escapean HTML por defecto
   ✓ Frontend debería usar innerText, no innerHTML
   ✗ Si devuelves HTML: usar mark_safe() con cuidado

3. NoSQL Injection
   ✓ No aplicable (usamos SQL)

4. Command Injection
   ✓ No aplicable (no ejecutamos comandos del sistema)
</code></pre></div></div>

<hr />

<h4 id="b-sanitización-de-salida"><strong>B. Sanitización de Salida</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># En serializers
</span><span class="k">class</span> <span class="nc">DocumentSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="p">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># Si necesitas HTML, usa mark_safe con cuidado
</span>        <span class="c1"># Por defecto Django escapea
</span>        <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="n">title</span>  <span class="c1"># Automáticamente escapado
</span></code></pre></div></div>

<hr />

<h3 id="74-seguridad-de-archivos-pdfs-uploads">7.4 Seguridad de Archivos (PDFs, Uploads)</h3>

<h4 id="a-almacenamiento-en-aws-s3"><strong>A. Almacenamiento en AWS S3</strong></h4>

<p><strong>Configuración:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py
</span><span class="n">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_ACCESS_KEY_ID'</span><span class="p">)</span>
<span class="n">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_SECRET_ACCESS_KEY'</span><span class="p">)</span>
<span class="n">AWS_STORAGE_BUCKET_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_STORAGE_BUCKET_NAME'</span><span class="p">)</span>
<span class="n">AWS_S3_REGION_NAME</span> <span class="o">=</span> <span class="s">'us-east-1'</span>
<span class="n">AWS_S3_CUSTOM_DOMAIN</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">AWS_STORAGE_BUCKET_NAME</span><span class="si">}</span><span class="s">.s3.amazonaws.com'</span>
<span class="n">AWS_S3_OBJECT_PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'CacheControl'</span><span class="p">:</span> <span class="s">'max-age=86400'</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">STORAGES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'BACKEND'</span><span class="p">:</span> <span class="s">'storages.backends.s3boto3.S3Boto3Storage'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">'staticfiles'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'BACKEND'</span><span class="p">:</span> <span class="s">'storages.backends.s3boto3.S3Boto3Storage'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Rutas Seguras:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Cada archivo en ruta con ID de usuario/documento
# Previene acceso directo a archivos de otros usuarios
</span>
<span class="n">upload_to</span><span class="o">=</span><span class="s">'documents/{year}/{month}/{filename}'</span>
<span class="c1"># Resultado: documents/2025/11/user_123_doc_456.pdf
</span>
<span class="n">upload_to</span><span class="o">=</span><span class="s">'expense_files/{id}_{filename}'</span>
<span class="c1"># Resultado: expense_files/100_receipt_001.pdf
</span></code></pre></div></div>

<hr />

<h4 id="b-validación-de-tipo-de-archivo"><strong>B. Validación de Tipo de Archivo</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># parsers.py / serializers.py
</span><span class="kn">import</span> <span class="nn">magic</span>

<span class="k">class</span> <span class="nc">FileValidator</span><span class="p">:</span>
    <span class="n">ALLOWED_MIME_TYPES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">'application/pdf'</span><span class="p">,</span>
        <span class="s">'image/jpeg'</span><span class="p">,</span>
        <span class="s">'image/png'</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">MAX_FILE_SIZE</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 5MB
</span>
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_file</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
        <span class="c1"># Validar tamaño
</span>        <span class="k">if</span> <span class="nb">file</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">FileValidator</span><span class="p">.</span><span class="n">MAX_FILE_SIZE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s">"File too large (max </span><span class="si">{</span><span class="mi">5</span><span class="si">}</span><span class="s">MB)"</span><span class="p">)</span>

        <span class="c1"># Validar tipo MIME (por magic bytes, no extensión)
</span>        <span class="n">mime_type</span> <span class="o">=</span> <span class="n">magic</span><span class="p">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span> <span class="n">mime</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="nb">file</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Reset
</span>
        <span class="k">if</span> <span class="n">mime_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FileValidator</span><span class="p">.</span><span class="n">ALLOWED_MIME_TYPES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Invalid file type: </span><span class="si">{</span><span class="n">mime_type</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># Validar extensión (como defensa adicional)
</span>        <span class="n">name</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">allowed_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s">'.pdf'</span><span class="p">,</span> <span class="s">'.jpg'</span><span class="p">,</span> <span class="s">'.jpeg'</span><span class="p">,</span> <span class="s">'.png'</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">allowed_extensions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">"Invalid file extension"</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p><strong>Uso:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ExpenseFileSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="p">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ExpenseFile</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">'file'</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">FileValidator</span><span class="p">.</span><span class="n">validate_file</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div>

<hr />

<h4 id="c-control-de-acceso-a-archivos"><strong>C. Control de Acceso a Archivos</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># views.py - Download/Retrieve archivo
</span><span class="k">class</span> <span class="nc">FileDownloadView</span><span class="p">(</span><span class="n">views</span><span class="p">.</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">file_id</span><span class="p">):</span>
        <span class="c1"># 1. Obtener archivo
</span>        <span class="nb">file</span> <span class="o">=</span> <span class="n">ExpenseFile</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">file_id</span><span class="p">)</span>

        <span class="c1"># 2. Validar permisos
</span>        <span class="n">expense</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">document_expense</span>
        <span class="k">if</span> <span class="n">expense</span><span class="p">.</span><span class="n">document</span><span class="p">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">:</span>
            <span class="c1"># Verificar si es aprobador
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_approver_for</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">expense</span><span class="p">.</span><span class="n">document</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PermissionDenied</span><span class="p">(</span><span class="s">"No access to this file"</span><span class="p">)</span>

        <span class="c1"># 3. Retornar archivo
</span>        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
            <span class="s">'url'</span><span class="p">:</span> <span class="nb">file</span><span class="p">.</span><span class="nb">file</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>  <span class="c1"># URL presignada S3
</span>            <span class="s">'name'</span><span class="p">:</span> <span class="nb">file</span><span class="p">.</span><span class="nb">file</span><span class="p">.</span><span class="n">name</span>
        <span class="p">})</span>
</code></pre></div></div>

<p><strong>URLs Presignadas en S3:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># boto3 genera URLs presignadas (válidas por tiempo limitado)
</span><span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">default_storage</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">default_storage</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="c1"># O con expiración:
</span><span class="n">url</span> <span class="o">=</span> <span class="n">default_storage</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
    <span class="s">"ResponseContentDisposition"</span><span class="p">:</span> <span class="s">"attachment; filename=file.pdf"</span>
<span class="p">},</span> <span class="n">expire_secs</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h3 id="75-logs-y-auditorías">7.5 Logs y Auditorías</h3>

<h4 id="a-logging-de-acciones"><strong>A. Logging de Acciones</strong></h4>

<p><strong>Configuración:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py
</span><span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'version'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">'disable_existing_loggers'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">'formatters'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'verbose'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'format'</span><span class="p">:</span> <span class="s">'{levelname} {asctime} {module} {message}'</span><span class="p">,</span>
            <span class="s">'style'</span><span class="p">:</span> <span class="s">'{'</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s">'handlers'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'file'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'level'</span><span class="p">:</span> <span class="s">'INFO'</span><span class="p">,</span>
            <span class="s">'class'</span><span class="p">:</span> <span class="s">'logging.FileHandler'</span><span class="p">,</span>
            <span class="s">'filename'</span><span class="p">:</span> <span class="s">'logs/app.log'</span><span class="p">,</span>
            <span class="s">'formatter'</span><span class="p">:</span> <span class="s">'verbose'</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">'console'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'level'</span><span class="p">:</span> <span class="s">'DEBUG'</span><span class="p">,</span>
            <span class="s">'class'</span><span class="p">:</span> <span class="s">'logging.StreamHandler'</span><span class="p">,</span>
            <span class="s">'formatter'</span><span class="p">:</span> <span class="s">'verbose'</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s">'loggers'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'app'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">'handlers'</span><span class="p">:</span> <span class="p">[</span><span class="s">'file'</span><span class="p">,</span> <span class="s">'console'</span><span class="p">],</span>
            <span class="s">'level'</span><span class="p">:</span> <span class="s">'INFO'</span><span class="p">,</span>
            <span class="s">'propagate'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">'app'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Eventos a Loguear:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># services/appraisal_service.py
</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"User </span><span class="si">{</span><span class="n">approver</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s"> approved expense </span><span class="si">{</span><span class="n">expense</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s"> at level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s">"User </span><span class="si">{</span><span class="n">approver</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s"> rejected expense </span><span class="si">{</span><span class="n">expense</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># auth.py
</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"User </span><span class="si">{</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s"> logged in from </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">META</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'REMOTE_ADDR'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed login attempt for username </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># views.py
</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Permission denied: User </span><span class="si">{</span><span class="n">user</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s"> accessed document </span><span class="si">{</span><span class="n">doc_id</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Salida Ejemplo:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO 2025-11-30 15:45:00 appraisal_service User carlos.supervisor approved expense 100 at level 1
INFO 2025-11-30 15:50:00 appraisal_service User maria.gerente approved expense 100 at level 2
INFO 2025-11-30 16:00:00 appraisal_service User juan.perez logged in from 192.168.1.100
WARNING 2025-11-30 16:05:00 auth Failed login attempt for username juan.perez (wrong password)
ERROR 2025-11-30 16:10:00 views Permission denied: User 5 accessed document 42
</code></pre></div></div>

<hr />

<h4 id="b-auditoría-con-approvalhistory"><strong>B. Auditoría con ApprovalHistory</strong></h4>

<p><strong>Tabla de Auditoría Integrada:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApprovalHistory</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># Quién, Qué, Cuándo, Resultado
</span>    <span class="n">approver</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="p">...)</span>  <span class="c1"># Quién
</span>    <span class="n">content_type</span> <span class="o">=</span> <span class="n">GenericForeignKey</span><span class="p">(...)</span>    <span class="c1"># Qué (tipo)
</span>    <span class="n">object_id</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span><span class="c1"># Qué (ID)
</span>    <span class="n">operation_date</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># Cuándo
</span>    <span class="n">level</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">...)</span>  <span class="c1"># Nivel
</span>    <span class="n">is_approved</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">BooleanField</span><span class="p">()</span>      <span class="c1"># Resultado
</span>    <span class="n">comments</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">TextField</span><span class="p">()</span>             <span class="c1"># Justificación
</span></code></pre></div></div>

<p><strong>Query Auditoría:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ver toda la aprobación de un documento
</span><span class="n">history</span> <span class="o">=</span> <span class="n">ApprovalHistory</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span>
    <span class="n">document</span><span class="o">=</span><span class="n">document</span>
<span class="p">).</span><span class="n">select_related</span><span class="p">(</span><span class="s">'approver'</span><span class="p">).</span><span class="n">order_by</span><span class="p">(</span><span class="s">'level'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Level </span><span class="si">{</span><span class="n">record</span><span class="p">.</span><span class="n">level</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">record</span><span class="p">.</span><span class="n">approver</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s"> "</span>
          <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="s">'Approved'</span> <span class="k">if</span> <span class="n">record</span><span class="p">.</span><span class="n">is_approved</span> <span class="k">else</span> <span class="s">'Rejected'</span><span class="si">}</span><span class="s"> "</span>
          <span class="sa">f</span><span class="s">"at </span><span class="si">{</span><span class="n">record</span><span class="p">.</span><span class="n">operation_date</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="checklist-de-seguridad">Checklist de Seguridad</h2>

<table>
  <thead>
    <tr>
      <th>Item</th>
      <th>Estado</th>
      <th>Notas</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Autenticación</strong></td>
      <td>✅ Token DRF</td>
      <td>Considerar agregar expiración</td>
    </tr>
    <tr>
      <td><strong>CSRF</strong></td>
      <td>✅ Configurado</td>
      <td>Deshabilitado en API (OK)</td>
    </tr>
    <tr>
      <td><strong>CORS</strong></td>
      <td>✅ Configurado</td>
      <td>Solo Vercel en prod</td>
    </tr>
    <tr>
      <td><strong>HTTPS</strong></td>
      <td>✅ Forzado</td>
      <td>En producción Render</td>
    </tr>
    <tr>
      <td><strong>Contraseñas</strong></td>
      <td>✅ PBKDF2</td>
      <td>Considerar migrar a Argon2</td>
    </tr>
    <tr>
      <td><strong>Validación Input</strong></td>
      <td>✅ Serializers</td>
      <td>Implementado en 3 niveles</td>
    </tr>
    <tr>
      <td><strong>Sanitización Output</strong></td>
      <td>✅ Django default</td>
      <td>Escapea HTML automáticamente</td>
    </tr>
    <tr>
      <td><strong>Archivos</strong></td>
      <td>✅ S3 + Validación</td>
      <td>MIME type + size + extensión</td>
    </tr>
    <tr>
      <td><strong>Logging</strong></td>
      <td>✅ Configurado</td>
      <td>Rotación de logs recomendada</td>
    </tr>
    <tr>
      <td><strong>Auditoría</strong></td>
      <td>✅ ApprovalHistory</td>
      <td>Historial completo de aprobaciones</td>
    </tr>
    <tr>
      <td><strong>Error Tracking</strong></td>
      <td>✅ Sentry</td>
      <td>Configurado para alertas</td>
    </tr>
    <tr>
      <td><strong>Rate Limiting</strong></td>
      <td>⚠️ Parcial</td>
      <td>1000 req/day, considerar mejorar</td>
    </tr>
    <tr>
      <td><strong>SQL Injection</strong></td>
      <td>✅ Previsto</td>
      <td>Django ORM no vulnerable</td>
    </tr>
    <tr>
      <td><strong>XSS</strong></td>
      <td>✅ Prevenido</td>
      <td>Serializers escapean</td>
    </tr>
    <tr>
      <td><strong>Secrets</strong></td>
      <td>✅ .env</td>
      <td>Nunca en git</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="8-configuración-y-entornos">8. Configuración y Entornos</h2>

<h3 id="81-variables-de-entorno">8.1 Variables de Entorno</h3>

<h4 id="a-setup-local-env"><strong>A. Setup Local (.env)</strong></h4>

<p>Crear archivo <code class="language-plaintext highlighter-rouge">.env</code> en raíz del proyecto:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Django Configuration</span>
<span class="nv">DJANGO_SECRET_KEY</span><span class="o">=</span>your-super-secret-key-here-change-in-production
<span class="nv">DEBUG</span><span class="o">=</span>True

<span class="c"># Database</span>
<span class="nv">DB_ENGINE</span><span class="o">=</span>django.db.backends.sqlite3
<span class="c"># O para PostgreSQL:</span>
<span class="c"># DB_ENGINE=django.db.backends.postgresql</span>
<span class="c"># DB_NAME=rinderline_db</span>
<span class="c"># DB_USER=rinderline_user</span>
<span class="c"># DB_PASSWORD=secure_password_here</span>
<span class="c"># DB_HOST=localhost</span>
<span class="c"># DB_PORT=5432</span>

<span class="c"># AWS S3 (File Storage)</span>
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>AKIAIOSFODNN7EXAMPLE
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
<span class="nv">AWS_STORAGE_BUCKET_NAME</span><span class="o">=</span>rinderline-storage-bucket
<span class="nv">AWS_S3_REGION_NAME</span><span class="o">=</span>us-east-1

<span class="c"># CORS</span>
<span class="nv">CORS_ALLOWED_ORIGINS</span><span class="o">=</span>http://localhost:3000,https://rinderline-webapp.vercel.app

<span class="c"># Sentry (Error Tracking)</span>
<span class="nv">SENTRY_DSN</span><span class="o">=</span>https://xxx@yyy.ingest.sentry.io/zzz

<span class="c"># Email (SMTP)</span>
<span class="nv">EMAIL_HOST</span><span class="o">=</span>smtp.gmail.com
<span class="nv">EMAIL_PORT</span><span class="o">=</span>587
<span class="nv">EMAIL_HOST_USER</span><span class="o">=</span>noreply@rinderline.com
<span class="nv">EMAIL_HOST_PASSWORD</span><span class="o">=</span>your-app-password
<span class="nv">EMAIL_USE_TLS</span><span class="o">=</span>True

<span class="c"># Exchange Rate Service</span>
<span class="nv">EXCHANGE_RATE_API_KEY</span><span class="o">=</span>your-api-key-here

<span class="c"># SAP Integration</span>
<span class="nv">SAP_HOST</span><span class="o">=</span>https://sap-system.example.com
<span class="nv">SAP_USERNAME</span><span class="o">=</span>sap_user
<span class="nv">SAP_PASSWORD</span><span class="o">=</span>sap_password

<span class="c"># Celery / Redis</span>
<span class="nv">CELERY_BROKER_URL</span><span class="o">=</span>redis://localhost:6379/0
<span class="nv">CELERY_RESULT_BACKEND</span><span class="o">=</span>redis://localhost:6379/0

<span class="c"># Environment</span>
<span class="nv">ENVIRONMENT</span><span class="o">=</span>development
</code></pre></div></div>

<hr />

<h4 id="b-variables-por-entorno"><strong>B. Variables por Entorno</strong></h4>

<p><strong>Desarrollo (DEBUG=True):</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- SQLite local
- CORS abierto a localhost:3000
- DEBUG mode activo (stack traces)
- Media files local
- Emails en console
- Sin validación HTTPS
</code></pre></div></div>

<p><strong>Staging (DEBUG=False, pero con logs detallados):</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- PostgreSQL remoto
- CORS a dominio de staging
- DEBUG mode desactivo
- Archivos en S3
- Emails reales
- HTTPS forzado
- Monitoreo de errores Sentry
</code></pre></div></div>

<p><strong>Producción (DEBUG=False, máxima seguridad):</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- PostgreSQL remoto
- CORS solo a rinderline-webapp.vercel.app
- DEBUG mode desactivo
- Archivos en S3
- Emails reales (Gmail/SendGrid)
- HTTPS forzado con HSTS
- Monitoreo de errores Sentry
- Rate limiting activo
- Backups de BD automáticos
</code></pre></div></div>

<hr />

<h3 id="82-django-settingspy-estructura-actual">8.2 Django Settings.py (Estructura Actual)</h3>

<h4 id="a-detección-de-entorno"><strong>A. Detección de Entorno</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py
</span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="n">load_dotenv</span><span class="p">()</span>  <span class="c1"># Carga .env
</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">__file__</span><span class="p">).</span><span class="n">resolve</span><span class="p">().</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span>

<span class="c1"># Auto-detect si está en Render o local
</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="s">'RENDER'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span>

<span class="c1"># Si está en Render: producción
# Si no está en Render: desarrollo/staging local
</span></code></pre></div></div>

<hr />

<h4 id="b-configuración-por-sección"><strong>B. Configuración por Sección</strong></h4>

<p><strong>1. Security</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'DJANGO_SECRET_KEY'</span><span class="p">)</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="s">'RENDER'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span>

<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'rinderline-api.onrender.com'</span><span class="p">,</span>      <span class="c1"># Render
</span>    <span class="s">'rinderline-webapp.vercel.app'</span><span class="p">,</span>      <span class="c1"># Frontend
</span>    <span class="s">'localhost'</span><span class="p">,</span>
    <span class="s">'127.0.0.1'</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># CSRF &amp; CORS
</span><span class="n">CSRF_COOKIE_SECURE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">DEBUG</span>        <span class="c1"># True en producción
</span><span class="n">SESSION_COOKIE_SECURE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">DEBUG</span>     <span class="c1"># True en producción
</span><span class="n">SECURE_SSL_REDIRECT</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">DEBUG</span>       <span class="c1"># True en producción
</span><span class="n">SECURE_HSTS_SECONDS</span> <span class="o">=</span> <span class="mi">31536000</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUG</span> <span class="k">else</span> <span class="mi">0</span>
</code></pre></div></div>

<p><strong>2. Database</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Desarrollo (SQLite)
</span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.sqlite3'</span><span class="p">,</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s">'db.sqlite3'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Producción (PostgreSQL - comentado para cambiar)
</span><span class="s">"""
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('DB_NAME'),
        'USER': os.getenv('DB_USER'),
        'PASSWORD': os.getenv('DB_PASSWORD'),
        'HOST': os.getenv('DB_HOST'),
        'PORT': os.getenv('DB_PORT'),
        'ATOMIC_REQUESTS': True,
        'CONN_MAX_AGE': 600,
    }
}
"""</span>
</code></pre></div></div>

<p><strong>3. Static &amp; Media Files</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">'/static/'</span>

<span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'stylescss'</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># En producción
</span><span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUG</span><span class="p">:</span>
    <span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'staticfiles'</span><span class="p">)</span>
    <span class="n">STATICFILES_STORAGE</span> <span class="o">=</span> <span class="s">'whitenoise.storage.CompressedManifestStaticFilesStorage'</span>
</code></pre></div></div>

<p><strong>4. S3 Storage</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_ACCESS_KEY_ID'</span><span class="p">)</span>
<span class="n">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_SECRET_ACCESS_KEY'</span><span class="p">)</span>
<span class="n">AWS_STORAGE_BUCKET_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'AWS_STORAGE_BUCKET_NAME'</span><span class="p">)</span>
<span class="n">AWS_S3_CUSTOM_DOMAIN</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">AWS_STORAGE_BUCKET_NAME</span><span class="si">}</span><span class="s">.s3.amazonaws.com'</span>
<span class="n">AWS_S3_FILE_OVERWRITE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">STORAGES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'BACKEND'</span><span class="p">:</span> <span class="s">'storages.backends.s3boto3.S3Boto3Storage'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">'staticfiles'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'BACKEND'</span><span class="p">:</span> <span class="s">'storages.backends.s3boto3.S3Boto3Storage'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>5. REST Framework</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'rest_framework.authentication.TokenAuthentication'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s">'DEFAULT_RENDERER_CLASSES'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'app.renderers.JSendRenderer'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s">'DEFAULT_THROTTLE_CLASSES'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'rest_framework.throttling.AnonRateThrottle'</span><span class="p">,</span>
        <span class="s">'rest_framework.throttling.UserRateThrottle'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s">'DEFAULT_THROTTLE_RATES'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'anon'</span><span class="p">:</span> <span class="s">'1000/day'</span><span class="p">,</span>
        <span class="s">'user'</span><span class="p">:</span> <span class="s">'1000/day'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">'DEFAULT_FILTER_BACKENDS'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'django_filters.rest_framework.DjangoFilterBackend'</span>
    <span class="p">],</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>6. CORS</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CORS_ALLOWED_ORIGINS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"https://rinderline-webapp.vercel.app"</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
    <span class="n">CORS_ALLOW_ALL_ORIGINS</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># Permite localhost:3000, localhost:8000, etc.
</span></code></pre></div></div>

<p><strong>7. Internacionalización</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s">'en-us'</span>
<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s">'UTC'</span>
<span class="n">USE_I18N</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">USE_TZ</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">LANGUAGES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">'en'</span><span class="p">,</span> <span class="s">'English'</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'es'</span><span class="p">,</span> <span class="s">'Spanish'</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'fr'</span><span class="p">,</span> <span class="s">'French'</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'de'</span><span class="p">,</span> <span class="s">'German'</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">LOCALE_PATHS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'locale'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<hr />

<h3 id="83-despliegue-en-render">8.3 Despliegue en Render</h3>

<h4 id="a-configuración-en-render-dashboard"><strong>A. Configuración en Render Dashboard</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Project: rinderline-backend
Region: Ohio (us-east-1)
Plan: Starter/Standard (según tráfico)

Build Command:
./build.sh

Start Command:
gunicorn rinderline.wsgi:application --bind 0.0.0.0:$PORT

Environment Variables:
- DJANGO_SECRET_KEY: [Generate strong key]
- DEBUG: False
- DB_ENGINE: django.db.backends.postgresql
- DB_NAME: rinderline_db
- DB_USER: postgres_user
- DB_PASSWORD: [Render DB password]
- DB_HOST: [Render internal DB host]
- DB_PORT: 5432
- AWS_ACCESS_KEY_ID: [AWS IAM credentials]
- AWS_SECRET_ACCESS_KEY: [AWS IAM credentials]
- AWS_STORAGE_BUCKET_NAME: rinderline-prod-storage
- SENTRY_DSN: [Sentry project DSN]
- ENVIRONMENT: production
</code></pre></div></div>

<hr />

<h4 id="b-build-script-buildsh"><strong>B. Build Script (build.sh)</strong></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># build.sh - Render deployment script</span>

<span class="nb">set</span> <span class="nt">-o</span> errexit  <span class="c"># Exit on error</span>

<span class="c"># 1. Install Python dependencies</span>
pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip
pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt

<span class="c"># 2. Collect static files</span>
python manage.py collectstatic <span class="nt">--no-input</span>

<span class="c"># 3. Run migrations</span>
python manage.py migrate

<span class="c"># 4. Create superuser (opcional, si no existe)</span>
<span class="c"># python manage.py createsuperuser --no-input</span>
</code></pre></div></div>

<p><strong>Permisos:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x build.sh
</code></pre></div></div>

<hr />

<h4 id="c-gunicorn-configuration"><strong>C. Gunicorn Configuration</strong></h4>

<p><strong>gunicorn_config.py (opcional, para production tuning):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="c1"># Número de workers basado en CPU cores
</span><span class="n">workers</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># Threads por worker
</span><span class="n">threads</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Timeout (segundos)
</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># Bind
</span><span class="n">bind</span> <span class="o">=</span> <span class="s">"0.0.0.0:8000"</span>

<span class="c1"># Logs
</span><span class="n">accesslog</span> <span class="o">=</span> <span class="s">"-"</span>
<span class="n">errorlog</span> <span class="o">=</span> <span class="s">"-"</span>
<span class="n">loglevel</span> <span class="o">=</span> <span class="s">"info"</span>

<span class="c1"># Keep-alive
</span><span class="n">keepalive</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div></div>

<p><strong>En Render Start Command:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gunicorn <span class="nt">-c</span> gunicorn_config.py rinderline.wsgi:application
</code></pre></div></div>

<hr />

<h3 id="84-base-de-datos">8.4 Base de Datos</h3>

<h4 id="a-migraciones"><strong>A. Migraciones</strong></h4>

<p><strong>Crear migración después de cambiar models:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python manage.py makemigrations
python manage.py migrate
</code></pre></div></div>

<p><strong>Listar migraciones:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python manage.py showmigrations
</code></pre></div></div>

<p><strong>Revertir migración:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python manage.py migrate app 0008_previous_migration
</code></pre></div></div>

<p><strong>Estado actual:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python manage.py migrate <span class="nt">--plan</span>  <span class="c"># Ver migrations a aplicar</span>
</code></pre></div></div>

<hr />

<h4 id="b-sqlite-desarrollo"><strong>B. SQLite (Desarrollo)</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.sqlite3'</span><span class="p">,</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s">'db.sqlite3'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Ubicación:</strong> <code class="language-plaintext highlighter-rouge">rinderline/db.sqlite3</code></p>

<p><strong>Inicializar:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python manage.py migrate
</code></pre></div></div>

<p><strong>Backup:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>db.sqlite3 db.sqlite3.backup
</code></pre></div></div>

<hr />

<h4 id="c-postgresql-producciónstaging"><strong>C. PostgreSQL (Producción/Staging)</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.postgresql'</span><span class="p">,</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'DB_NAME'</span><span class="p">),</span>
        <span class="s">'USER'</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'DB_USER'</span><span class="p">),</span>
        <span class="s">'PASSWORD'</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'DB_PASSWORD'</span><span class="p">),</span>
        <span class="s">'HOST'</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'DB_HOST'</span><span class="p">),</span>
        <span class="s">'PORT'</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'DB_PORT'</span><span class="p">),</span>
        <span class="s">'ATOMIC_REQUESTS'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>       <span class="c1"># Transacciones atómicas
</span>        <span class="s">'CONN_MAX_AGE'</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>           <span class="c1"># Connection pooling
</span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Instalación Local (Windows PowerShell):</strong></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1. Install PostgreSQL from https://www.postgresql.org/download/windows/</span><span class="w">

</span><span class="c"># 2. Start PostgreSQL service</span><span class="w">
</span><span class="n">Get-Service</span><span class="w"> </span><span class="nx">postgresql</span><span class="o">*</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Start-Service</span><span class="w">

</span><span class="c"># 3. Create database</span><span class="w">
</span><span class="n">psql</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">postgres</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"CREATE DATABASE rinderline_db;"</span><span class="w">
</span><span class="n">psql</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">postgres</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"CREATE USER rinderline_user WITH PASSWORD 'password';"</span><span class="w">
</span><span class="n">psql</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">postgres</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"ALTER ROLE rinderline_user SET client_encoding TO 'utf8';"</span><span class="w">
</span><span class="n">psql</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">postgres</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"ALTER ROLE rinderline_user SET default_transaction_isolation TO 'read committed';"</span><span class="w">
</span><span class="n">psql</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">postgres</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"ALTER ROLE rinderline_user SET default_transaction_deferrable TO on;"</span><span class="w">
</span><span class="n">psql</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">postgres</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"GRANT ALL PRIVILEGES ON DATABASE rinderline_db TO rinderline_user;"</span><span class="w">

</span><span class="c"># 4. Connect and verify</span><span class="w">
</span><span class="n">psql</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="nx">rinderline_user</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">rinderline_db</span><span class="w">
</span></code></pre></div></div>

<p><strong>Backup &amp; Restore:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Backup</span>
pg_dump <span class="nt">-U</span> rinderline_user <span class="nt">-h</span> localhost rinderline_db <span class="o">&gt;</span> backup.sql

<span class="c"># Restore</span>
psql <span class="nt">-U</span> rinderline_user <span class="nt">-h</span> localhost rinderline_db &lt; backup.sql
</code></pre></div></div>

<hr />

<h3 id="85-requirementstxt">8.5 Requirements.txt</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Django==5.2.8
djangorestframework==3.15.2
django-cors-headers==4.4.0
django-filter==24.3
drf-yasg==1.21.7
whitenoise==6.6.0
boto3==1.34.33
django-storages==1.14.2
psycopg2-binary==2.9.9
celery==5.3.4
redis==5.0.1
sentry-sdk==1.39.2
python-decouple==3.8
python-dotenv==1.0.0
requests==2.31.0
Pillow==10.1.0
gunicorn==21.2.0
</code></pre></div></div>

<p><strong>Instalar:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
</code></pre></div></div>

<p><strong>Generar requirements.txt:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip freeze <span class="o">&gt;</span> requirements.txt
</code></pre></div></div>

<hr />

<h3 id="86-checklist-de-deployment">8.6 Checklist de Deployment</h3>

<table>
  <thead>
    <tr>
      <th>Paso</th>
      <th>Descripción</th>
      <th>Prod</th>
      <th>Staging</th>
      <th>Dev</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>1. Código</strong></td>
      <td>Último commit en main</td>
      <td>✅</td>
      <td>✅</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>2. Env Vars</strong></td>
      <td>Todos los .env configurados</td>
      <td>✅</td>
      <td>✅</td>
      <td>✅</td>
    </tr>
    <tr>
      <td><strong>3. Migrations</strong></td>
      <td>Ejecutar makemigrations + migrate</td>
      <td>✅</td>
      <td>✅</td>
      <td>✅</td>
    </tr>
    <tr>
      <td><strong>4. Static Files</strong></td>
      <td>Collectstatic en S3</td>
      <td>✅</td>
      <td>✅</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>5. Tests</strong></td>
      <td>Todos los tests pasando</td>
      <td>✅</td>
      <td>✅</td>
      <td>✅</td>
    </tr>
    <tr>
      <td><strong>6. Security</strong></td>
      <td>DEBUG=False, SECRET_KEY único</td>
      <td>✅</td>
      <td>✅</td>
      <td>✅</td>
    </tr>
    <tr>
      <td><strong>7. DB Backup</strong></td>
      <td>Backup de BD anterior</td>
      <td>✅</td>
      <td>✅</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>8. SSL/TLS</strong></td>
      <td>HTTPS forzado</td>
      <td>✅</td>
      <td>✅</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>9. CORS</strong></td>
      <td>Dominios correctos configurados</td>
      <td>✅</td>
      <td>✅</td>
      <td>✅</td>
    </tr>
    <tr>
      <td><strong>10. Monitoring</strong></td>
      <td>Sentry conectado</td>
      <td>✅</td>
      <td>✅</td>
      <td>-</td>
    </tr>
    <tr>
      <td><strong>11. Logs</strong></td>
      <td>Logging configurado</td>
      <td>✅</td>
      <td>✅</td>
      <td>✅</td>
    </tr>
    <tr>
      <td><strong>12. Health Check</strong></td>
      <td>Endpoint /health/ funcionando</td>
      <td>✅</td>
      <td>✅</td>
      <td>✅</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="87-troubleshooting-común">8.7 Troubleshooting Común</h3>

<h4 id="a-errores-de-migración"><strong>A. Errores de Migración</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Error: Relation "app_model" does not exist
# Solución:
</span><span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">migrate</span> <span class="o">--</span><span class="n">fake</span><span class="o">-</span><span class="n">initial</span>
<span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">migrate</span>

<span class="c1"># Error: Duplicated columns
# Solución:
</span><span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">migrate</span> <span class="n">app</span> <span class="n">zero</span>
<span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">migrate</span>
</code></pre></div></div>

<h4 id="b-problemas-de-estáticos"><strong>B. Problemas de Estáticos</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Archivos .js/.css no se cargan
# Solución:
</span><span class="n">python</span> <span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">collectstatic</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="nb">input</span> <span class="o">--</span><span class="n">clear</span>

<span class="c1"># En settings.py verificar:
</span><span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">'/static/'</span>
<span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'staticfiles'</span><span class="p">)</span>
<span class="n">STATICFILES_STORAGE</span> <span class="o">=</span> <span class="s">'whitenoise.storage.CompressedManifestStaticFilesStorage'</span>
</code></pre></div></div>

<h4 id="c-conexión-a-bd"><strong>C. Conexión a BD</strong></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># PostgreSQL no conecta</span>
<span class="c"># Verificar:</span>
psql <span class="nt">-U</span> rinderline_user <span class="nt">-h</span> localhost <span class="nt">-d</span> rinderline_db

<span class="c"># SQLite corrupta</span>
python manage.py dbshell
.quit

<span class="c"># Eliminar y recrear</span>
<span class="nb">rm </span>db.sqlite3
python manage.py migrate
</code></pre></div></div>

<h4 id="d-errores-de-permisos-s3"><strong>D. Errores de Permisos S3</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Error: Access Denied
# Verificar en AWS:
</span><span class="mf">1.</span> <span class="n">AWS_ACCESS_KEY_ID</span> <span class="n">correcto</span>
<span class="mf">2.</span> <span class="n">AWS_SECRET_ACCESS_KEY</span> <span class="n">correcto</span>
<span class="mf">3.</span> <span class="n">IAM</span> <span class="n">user</span> <span class="n">tiene</span> <span class="n">permisos</span> <span class="n">S3</span><span class="p">:</span><span class="n">GetObject</span><span class="p">,</span> <span class="n">S3</span><span class="p">:</span><span class="n">PutObject</span>
<span class="mf">4.</span> <span class="n">Bucket</span> <span class="n">name</span> <span class="n">correcto</span>

<span class="c1"># En Django:
</span><span class="n">AWS_QUERYSTRING_AUTH</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1"># URLs públicas sin firma
</span></code></pre></div></div>

<hr />

<h2 id="resumen-de-configuración-por-entorno">Resumen de Configuración por Entorno</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─────────────────────────────────────────────────────────┐
│           DESARROLLO (DEBUG=True, Local)                │
├─────────────────────────────────────────────────────────┤
│ DB: SQLite (db.sqlite3)                                 │
│ Storage: Local filesystem                               │
│ CORS: Abierto (localhost:3000, localhost:8000)          │
│ Email: Console backend                                  │
│ Logs: Console + archivo                                 │
│ Secretos: .env local                                    │
│ HTTPS: No required                                      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│         STAGING (DEBUG=False, Remote server)            │
├─────────────────────────────────────────────────────────┤
│ DB: PostgreSQL (Render managed)                         │
│ Storage: AWS S3                                         │
│ CORS: staging-api.example.com + vercel.app              │
│ Email: SMTP real (Gmail/SendGrid)                       │
│ Logs: Sentry + archivo                                  │
│ Secretos: Render environment variables                  │
│ HTTPS: Forzado (Let's Encrypt)                          │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│      PRODUCCIÓN (DEBUG=False, Render managed)           │
├─────────────────────────────────────────────────────────┤
│ DB: PostgreSQL (Render managed + backups)               │
│ Storage: AWS S3 (prod bucket)                           │
│ CORS: rinderline-webapp.vercel.app (solo)               │
│ Email: SMTP con alta confiabilidad                      │
│ Logs: Sentry alertas + auditlog                         │
│ Secretos: Render secrets (cifrados)                     │
│ HTTPS: Forzado + HSTS + preload                         │
│ Rate limiting: Activo (1000 req/día)                    │
│ Backups: Diarios + replicación                          │
└─────────────────────────────────────────────────────────┘
</code></pre></div></div>

<hr />

<h2 id="documentación-técnica---resumen-general">Documentación Técnica - Resumen General</h2>

<p>Esta documentación cubre 8 puntos principales del backend Rinderline:</p>

<ol>
  <li><strong>Arquitectura General:</strong> Componentes, request lifecycle, integraciones</li>
  <li><strong>Estructura del Proyecto:</strong> Carpetas, módulos, convenciones, dependencias</li>
  <li><strong>Modelos y BD:</strong> 24 modelos, diagrama ER, validaciones, migraciones</li>
  <li><strong>API y Endpoints:</strong> 25+ endpoints, autenticación, autorización, ejemplos</li>
  <li><strong>Servicios:</strong> Business logic, async tasks, integraciones externas</li>
  <li><strong>Seguridad:</strong> Autenticación, CSRF/CORS, validación, auditoría</li>
  <li><strong>Configuración:</strong> Variables de entorno, settings.py, despliegue</li>
  <li><strong>Entornos:</strong> Dev/Staging/Prod, migraciones, monitoreo</li>
</ol>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
